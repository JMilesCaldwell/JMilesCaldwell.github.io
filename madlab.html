<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fantasy Dope Wars: Evershroud Edition</title>
  <style>
    /* Basic Reset & Sizing */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    body {
      background: #333 url('resources/docks.png') no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      color: #eee;
    }
    .container {
      max-width: 900px;
      margin: 1rem auto;
      background: rgba(0,0,0,0.7);
      padding: 1rem;
      border-radius: 8px;
    }
    h1, h2, h3, h4 {
      margin-bottom: 0.5rem;
      font-family: serif;
    }
    label, select, input {
      margin: 0.3rem 0;
    }
    .button {
      background: #650000;
      color: #eee;
      border: 1px solid #300000;
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .button:hover {
      background: #500000;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    th, td {
      border: 1px solid #444;
      padding: 0.4rem;
      text-align: center;
      background: rgba(255,255,255,0.1);
    }
    th {
      background: #550000;
    }
    .log {
      max-height: 180px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      border: 1px solid #444;
      padding: 0.5rem;
      border-radius: 5px;
      margin: 0.5rem 0;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .alert { color: #ffaaaa; font-weight: bold; }
    @media (max-width:600px){
      .flex-row {flex-direction: column;}
      .log {max-height: 120px;}
    }
  </style>
</head>
<body>
<div class="container" id="setupContainer">
  <h1>Fantasy Dope Wars: Evershroud Edition</h1>
  <p>
    Buy and sell goods, travel between the Evershroud coastal locations, avoid (or fight) 
    ruffians, and pay off your debt before time’s up—or meet your fate. Good luck!
  </p>
  <label>Game Length (Days): 
    <select id="gameDays">
      <option value="15">15 (Short)</option>
      <option value="30" selected>30 (Standard)</option>
      <option value="60">60 (Long)</option>
    </select>
  </label>
  <br>
  <label>Starting Gold: 
    <input type="number" id="startGold" value="100" style="width:80px;">
  </label>
  <br>
  <label>Starting Debt: 
    <input type="number" id="startDebt" value="500" style="width:80px;">
  </label>
  <br>
  <label>Cargo Capacity:
    <input type="number" id="startCargo" value="50" style="width:80px;">
  </label>
  <br>
  <label>Starting HP:
    <input type="number" id="startHP" value="100" style="width:80px;">
  </label>
  <br><br>
  <button class="button" onclick="startGame()">Begin</button>
</div>

<div class="container hidden" id="gameContainer">
  <h2>Status</h2>
  <p id="statusLine"></p>
  <div class="flex-row">
    <div>
      <label for="locationSelect">Location:</label>
      <select id="locationSelect"></select>
    </div>
    <button class="button" onclick="travel()">Travel (Ends Day)</button>
    <button class="button" onclick="payDebtPrompt()">Pay Debt</button>
  </div>

  <div class="flex-row" style="justify-content: space-between;">
    <div>
      <h3>Market</h3>
      <table id="marketTable">
        <thead>
          <tr>
            <th>Good</th>
            <th>Price (GP)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div>
      <h3>Inventory</h3>
      <table id="inventoryTable">
        <thead>
          <tr>
            <th>Good</th>
            <th>Qty</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <h3>Log</h3>
  <div class="log" id="logArea"></div>

  <div id="fightContainer" class="hidden">
    <h4>Ruffians Attack!</h4>
    <p id="fightText"></p>
    <button class="button" onclick="attemptRun()">Run</button>
    <button class="button" onclick="attemptFight()">Fight</button>
  </div>
</div>

<!-- Game Over Screen -->
<div class="container hidden" id="gameOverContainer">
  <h2 id="gameOverTitle">Game Over</h2>
  <p id="gameOverMessage"></p>
  <button class="button" onclick="backToMainMenu()">Back to Main Menu</button>
</div>

<script>
/*******************************************************
 * 1) Data: Goods & Travel Locations (from your snippets)
 *******************************************************/
// The user’s goods:
const goodsList = [
  { name: "Amber", minPrice: 5, maxPrice: 20 },
  { name: "Salt", minPrice: 1, maxPrice: 5 },
  { name: "Tin", minPrice: 4, maxPrice: 10 },
  { name: "Wool", minPrice: 3, maxPrice: 8 },
  { name: "Timber", minPrice: 6, maxPrice: 12 },
  { name: "Salted Fish", minPrice: 2, maxPrice: 7 },
  { name: "Copper", minPrice: 8, maxPrice: 20 },
  { name: "Blackleaf", minPrice: 15, maxPrice: 35 },
  { name: "Botanical Specimens", minPrice: 10, maxPrice: 28 },
  { name: "Fungus", minPrice: 2, maxPrice: 6 },
  { name: "Artifacts", minPrice: 25, maxPrice: 60 },
  { name: "Luxury Goods", minPrice: 40, maxPrice: 100 },
  { name: "Weapons/Armor", minPrice: 25, maxPrice: 70 },
  { name: "Bronze", minPrice: 20, maxPrice: 45 },
  { name: "Incense", minPrice: 15, maxPrice: 30 },
  { name: "Wine", minPrice: 3, maxPrice: 9 },
  { name: "Ale", minPrice: 1, maxPrice: 4 },
  { name: "Iron", minPrice: 30, maxPrice: 60 },
  { name: "Grain", minPrice: 1, maxPrice: 3 },
];

// The user’s travel locations (from Coastal Travel System):
const travelLocations = [
  { name: "Azure", risk: 2 },
  { name: "Sylfaene", risk: 3 },
  { name: "Holgren", risk: 4 },
  { name: "Ryer", risk: 2 },
  { name: "Waglynn Lighthouse", risk: 4 },
  { name: "Mong Harrad", risk: 4 },
  { name: "World's End", risk: 5 },
  { name: "Fulcimer Lighthouse", risk: 3 },
  { name: "Vigden", risk: 3 },
  { name: "Virgil", risk: 2 },
  { name: "Hermit Sanctum", risk: 2 },
  { name: "Wren", risk: 4 },
  { name: "Villegrom Estate", risk: 5 },
  { name: "Silt", risk: 5 },
  { name: "Freeport", risk: 1 },
  { name: "Morgrin Lighthouse", risk: 3 },
  { name: "Mong Vinaya", risk: 4 },
  { name: "Meowygg", risk: 2 },
  { name: "Devyth", risk: 2 },
  { name: "Commorragh", risk: 5 },
  { name: "Refuge", risk: 1 },
  { name: "Giant's Head", risk: 1 }
];

// We’ll store randomized daily prices as an object: { cityName: { goodName: price } }
let dailyPrices = {};

// Game state
let day = 1, maxDays = 30;
let gold = 100, debt = 500;
let cargoMax = 50, cargoUsed = 0;
let playerHP = 100;
let currentLocation = "Azure";
let ended = false;

// Inventory object: { 'Amber': 0, 'Salt': 0, ... }
let inventory = {};

/*******************************************************
 * 2) Setup / Start
 *******************************************************/
function startGame() {
  day = 1;
  maxDays = parseInt(document.getElementById("gameDays").value, 10);
  gold = parseInt(document.getElementById("startGold").value, 10);
  debt = parseInt(document.getElementById("startDebt").value, 10);
  cargoMax = parseInt(document.getElementById("startCargo").value, 10);
  playerHP = parseInt(document.getElementById("startHP").value, 10);
  ended = false;
  cargoUsed = 0;
  currentLocation = travelLocations[0].name;

  // Clear inventory
  inventory = {};
  goodsList.forEach(g => inventory[g.name] = 0);

  // Populate locationSelect
  const locSelect = document.getElementById("locationSelect");
  locSelect.innerHTML = "";
  travelLocations.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc.name;
    opt.textContent = loc.name;
    locSelect.appendChild(opt);
  });
  locSelect.value = currentLocation;

  // Hide setup, show game
  document.getElementById("setupContainer").classList.add("hidden");
  document.getElementById("gameContainer").classList.remove("hidden");
  document.getElementById("gameOverContainer").classList.add("hidden");

  // Make initial random prices
  randomizePrices();
  refreshUI();
  log(`Welcome! You have ${maxDays} days to pay off your debt of ${debt} GP. Stay alive and prosper!`);
}

function randomizePrices() {
  dailyPrices = {};
  travelLocations.forEach(loc => {
    dailyPrices[loc.name] = {};
    goodsList.forEach(g => {
      const base = randInt(g.minPrice, g.maxPrice);
      const variance = 1 + (Math.random() * 0.4 - 0.2); // +/- 20%
      dailyPrices[loc.name][g.name] = Math.max(1, Math.floor(base * variance));
    });
  });
}

/*******************************************************
 * 3) UI & Helpers
 *******************************************************/
function refreshUI() {
  // Status line
  const statusText = 
    `Day ${day}/${maxDays}, Location: ${currentLocation}, ` +
    `Gold: ${gold}, Debt: ${debt}, HP: ${playerHP}, ` +
    `Cargo: ${cargoUsed}/${cargoMax}`;
  document.getElementById("statusLine").textContent = statusText;

  // Market table
  const marketBody = document.getElementById("marketTable").querySelector("tbody");
  marketBody.innerHTML = "";
  goodsList.forEach(g => {
    const price = dailyPrices[currentLocation][g.name];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${g.name}</td>
      <td>${price} GP</td>
      <td>
        <button class="button" onclick="buyPrompt('${g.name}')">Buy</button>
        <button class="button" onclick="sellPrompt('${g.name}')">Sell</button>
      </td>
    `;
    marketBody.appendChild(tr);
  });

  // Inventory table
  const invBody = document.getElementById("inventoryTable").querySelector("tbody");
  invBody.innerHTML = "";
  goodsList.forEach(g => {
    const qty = inventory[g.name];
    if (qty > 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${g.name}</td><td>${qty}</td>`;
      invBody.appendChild(tr);
    }
  });
}

function log(msg) {
  const logArea = document.getElementById("logArea");
  logArea.innerHTML = msg + "\n" + logArea.innerHTML;
}
function randInt(min, max) {
  return Math.floor(Math.random()*(max-min+1))+min;
}
function getLocationObj(name) {
  return travelLocations.find(l => l.name===name);
}

/*******************************************************
 * 4) Buying / Selling
 *******************************************************/
function buyPrompt(goodName) {
  if (ended) return;
  const price = dailyPrices[currentLocation][goodName];
  const maxAfford = Math.floor(gold / price);
  const maxSpace = cargoMax - cargoUsed;
  const maxCanBuy = Math.min(maxAfford, maxSpace);
  if (maxCanBuy<=0) {
    log(`<span class="alert">Not enough gold or cargo space to buy ${goodName}!</span>`);
    return;
  }
  const qtyStr = prompt(`Buy how many units of ${goodName}? (Up to ${maxCanBuy})`);
  if (!qtyStr) return;
  const qty = parseInt(qtyStr, 10);
  if (!qty || qty<1) return;
  if (qty>maxCanBuy) {
    log(`<span class="alert">You can only buy up to ${maxCanBuy} units!</span>`);
    return;
  }
  const cost = qty*price;
  gold -= cost;
  inventory[goodName]+=qty;
  cargoUsed+=qty;
  log(`Bought ${qty} x ${goodName} @ ${price} GP = ${cost} GP total.`);
  refreshUI();
}
function sellPrompt(goodName) {
  if (ended) return;
  const have = inventory[goodName];
  if (have<=0) {
    log(`<span class="alert">You have no ${goodName} to sell!</span>`);
    return;
  }
  const price = dailyPrices[currentLocation][goodName];
  const qtyStr = prompt(`Sell how many units of ${goodName}? (You have ${have})`);
  if (!qtyStr) return;
  const qty = parseInt(qtyStr, 10);
  if (!qty || qty<1) return;
  if (qty>have) {
    log(`<span class="alert">You only have ${have} units!</span>`);
    return;
  }
  const income = qty*price;
  gold+=income;
  inventory[goodName]-=qty;
  cargoUsed-=qty;
  log(`Sold ${qty} x ${goodName} @ ${price} GP = ${income} GP total.`);
  refreshUI();
}

/*******************************************************
 * 5) Travel (ends day, triggers random events)
 *******************************************************/
function travel() {
  if (ended) return;
  if (day>=maxDays) {
    log(`<span class="alert">No more days left to travel!</span>`);
    return;
  }
  const locSelect = document.getElementById("locationSelect");
  const newLoc = locSelect.value;
  if (newLoc===currentLocation) {
    log(`<span class="alert">You're already in ${currentLocation}!</span>`);
    return;
  }
  currentLocation = newLoc;
  day++;
  log(`Travelled to <strong>${currentLocation}</strong>. Day ${day} of ${maxDays}.`);
  doRandomEvent();
  randomizePrices();
  refreshUI();
  checkGameEnd();
}

/*******************************************************
 * 6) Pay Debt
 *******************************************************/
function payDebtPrompt() {
  if (ended) return;
  if (debt<=0) {
    log(`Debt already cleared!`);
    return;
  }
  const amountStr = prompt(`How much to pay? (Debt: ${debt}, Gold: ${gold})`);
  if (!amountStr) return;
  const amt = parseInt(amountStr, 10);
  if (!amt || amt<1) return;
  if (amt>gold) {
    log(`<span class="alert">You don't have that much gold!</span>`);
    return;
  }
  gold-=amt;
  debt-=amt;
  if (debt<0) debt=0;
  log(`Paid ${amt} GP towards debt. Remaining debt: ${debt}.`);
  if (debt<=0) {
    log(`<span class="alert">Congratulations! You cleared your debt!</span>`);
  }
  refreshUI();
  checkGameEnd();
}

/*******************************************************
 * 7) Random Events on Travel
 *******************************************************/
function doRandomEvent() {
  const locObj = getLocationObj(currentLocation);
  const risk = locObj?.risk || 3;
  const roll = Math.random()*10;
  if (roll<risk) {
    // Attack occurs
    showFightPrompt();
  } else {
    // maybe something beneficial or neutral
    const chance = Math.random();
    if (chance<0.3) {
      // find some goods
      const foundGood = pickRandom(goodsList);
      const foundQty = randInt(1,3);
      if (cargoUsed+foundQty<=cargoMax) {
        inventory[foundGood.name]+=foundQty;
        cargoUsed+=foundQty;
        log(`Lucky break! You found ${foundQty} x ${foundGood.name} abandoned along the road.`);
      } else {
        log(`You found some ${foundGood.name}, but have no cargo space to take it.`);
      }
    } else {
      log(`A quiet day... nothing special happens.`);
    }
  }
}

function pickRandom(arr) {
  return arr[Math.floor(Math.random()*arr.length)];
}

/*******************************************************
 * 8) Fighting / Running from Ruffians
 *******************************************************/
function showFightPrompt() {
  document.getElementById("fightContainer").classList.remove("hidden");
  document.getElementById("fightText").textContent = 
    `Ruffians ambush you near ${currentLocation}! Will you run or fight?`;
}

function hideFightPrompt() {
  document.getElementById("fightContainer").classList.add("hidden");
  document.getElementById("fightText").textContent = "";
}

// Attempt to flee
function attemptRun() {
  hideFightPrompt();
  const roll = Math.random();
  if (roll<0.4) {
    // fail to run => forced fight
    log(`<span class="alert">You try to run, but the ruffians catch you!</span>`);
    doFight();
  } else {
    // success
    log(`You sprint away, narrowly escaping the ruffians!`);
  }
}

// Attempt to fight
function attemptFight() {
  hideFightPrompt();
  doFight();
}

function doFight() {
  // We'll do a simple formula:
  // ruffians have "attack power" ~ 20-60
  // player has "HP"
  // if player's HP < ruffians' power => player might die
  const ruffianPower = randInt(20,60);
  const playerPower = randInt(15,70);
  
  if (playerPower>=ruffianPower) {
    // player wins
    log(`You fought the ruffians! Their power: ${ruffianPower}, yours: ${playerPower}. You win!`);
    // maybe some gold or items?
    const loot = randInt(10,50);
    gold+=loot;
    log(`You loot ${loot} GP off their bodies.`);
  } else {
    // player suffers damage
    const damage = randInt(10,30);
    playerHP -= damage;
    log(`<span class="alert">Fierce fight! Their power: ${ruffianPower}, yours: ${playerPower}. You take ${damage} damage!</span>`);
    if (playerHP<=0) {
      playerHP=0;
      log(`<span class="alert">You have been slain by the ruffians!</span>`);
      endGame(false, "Killed in battle...");
    }
  }
  refreshUI();
}

/*******************************************************
 * 9) Check End Conditions
 *******************************************************/
function checkGameEnd() {
  if (day>maxDays && debt>0 && !ended) {
    endGame(false, "Time’s up and your debt remains unpaid.");
  }
  // If debt <= 0, the user can continue playing or effectively "won." 
  // We'll let them keep going until day > maxDays or they wish to do so.
}

// forced end
function endGame(victory, reason) {
  ended=true;
  document.getElementById("gameContainer").classList.add("hidden");
  document.getElementById("gameOverContainer").classList.remove("hidden");
  
  const netWorth = gold + approximateInventoryValue();
  if(!victory) {
    document.getElementById("gameOverTitle").textContent="Game Over (Failure)";
    document.getElementById("gameOverMessage").innerHTML =
      reason + "<br>Your net worth was ~" + netWorth + " GP.";
  } else {
    document.getElementById("gameOverTitle").textContent="Game Over (Success)";
    document.getElementById("gameOverMessage").innerHTML =
      reason + "<br>Your final net worth: ~" + netWorth + " GP.";
  }
}

function approximateInventoryValue() {
  // Just approximate by average prices
  let total=0;
  goodsList.forEach(g=>{
    const avgPrice=(g.minPrice+g.maxPrice)/2;
    total+=avgPrice*inventory[g.name];
  });
  return Math.floor(total);
}

function backToMainMenu() {
  // hide gameOver, show setup
  document.getElementById("setupContainer").classList.remove("hidden");
  document.getElementById("gameContainer").classList.add("hidden");
  document.getElementById("gameOverContainer").classList.add("hidden");
}

/*******************************************************
 * Done.
 *******************************************************/

</script>
</body>
</html>
