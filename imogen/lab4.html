<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mandala Generator · Lab 3 · Imogen</title>
  <link rel="icon" href="resources/Imogen.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Serif+Tibetan&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #12100e 0%, #201815 50%, #12100e 100%);
      color: #e0d5c5;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navigation Bar */
    .navbar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(18, 16, 14, 0.95);
      padding: 1rem 2rem;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      border-bottom: 1px solid rgba(255, 215, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .navbar a {
      color: #a89050;
      font-size: 0.95rem;
      font-weight: 500;
      text-decoration: none;
      margin: 0 1.5rem;
      padding: 0.5rem 0;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .navbar a:hover { color: #ffd700; border-bottom-color: #ffd700; }

    /* Main Container */
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 7rem 2rem 2rem;
      gap: 2rem;
    }

    /* Header Text */
    .header-group {
      text-align: center;
      max-width: 600px;
    }

    .title {
      font-size: 2rem;
      font-weight: 300;
      color: #d4b455;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #8a7a6a;
      line-height: 1.5;
    }

    .subtitle strong { color: #bca060; font-weight: 500; }

    /* Input Section */
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      width: 100%;
      max-width: 550px;
      background: rgba(30, 24, 20, 0.6);
      padding: 2rem;
      border-radius: 16px;
      border: 1px solid rgba(212, 180, 85, 0.15);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .input-row {
      display: flex;
      gap: 1rem;
      width: 100%;
    }

    .text-input {
      flex: 2;
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      font-family: inherit;
      background: rgba(212, 180, 85, 0.05);
      border: 1px solid rgba(212, 180, 85, 0.2);
      border-radius: 8px;
      color: #ffd700;
      transition: all 0.3s ease;
      outline: none;
    }

    .date-input {
      flex: 1;
      padding: 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: rgba(212, 180, 85, 0.05);
      border: 1px solid rgba(212, 180, 85, 0.2);
      border-radius: 8px;
      color: #ffd700;
      outline: none;
      cursor: pointer;
      text-align: center;
    }

    ::-webkit-calendar-picker-indicator {
      filter: invert(1) sepia(100%) saturate(1000%) hue-rotate(0deg) brightness(1.2);
      cursor: pointer;
    }

    .text-input:focus, .date-input:focus {
      border-color: #d4b455;
      background: rgba(212, 180, 85, 0.08);
    }

    .meta-display {
      display: flex;
      justify-content: space-between;
      width: 100%;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(212, 180, 85, 0.1);
      margin-top: 0.5rem;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
    }

    .meta-label { color: #605040; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.7rem; }
    .meta-value { color: #d4b455; font-family: monospace; }
    .tibetan-font { font-family: 'Noto Serif Tibetan', serif; font-size: 1.2rem; line-height: 1; }

    /* Canvas */
    .canvas-wrapper {
      position: relative;
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 20px;
    }

    #mandala-canvas {
      border-radius: 50%; /* Circular clipping for the canvas itself looks nice */
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      max-width: 100%;
      height: auto;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 0.7rem 1.5rem;
      font-size: 0.85rem;
      font-weight: 500;
      background: transparent;
      border: 1px solid rgba(212, 180, 85, 0.3);
      border-radius: 6px;
      color: #d4b455;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: rgba(212, 180, 85, 0.1);
      border-color: #ffd700;
      color: #ffd700;
    }

    .btn.small { padding: 0.5rem 0.8rem; min-width: 40px; }
    
    .speed-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(212, 180, 85, 0.05);
      border-radius: 6px;
      padding: 0 0.5rem;
      border: 1px solid rgba(212, 180, 85, 0.1);
    }
    
    .speed-display { font-family: monospace; color: #a89050; min-width: 3.5rem; text-align: center; }

    /* Fullscreen Mode */
    .fullscreen-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: #080706;
      z-index: 9999;
      justify-content: center; align-items: center;
    }

    .fullscreen-overlay.active { display: flex; cursor: none; }

    /* Hover zone at the bottom to reveal controls */
    .fullscreen-hover-zone {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 15vh;
      display: flex; justify-content: center; align-items: flex-end;
      padding-bottom: 2rem;
      z-index: 10000;
    }

    /* Controls are hidden by default, visible only on hover of the zone */
    .fullscreen-controls {
      display: flex; gap: 1rem; align-items: center;
      background: rgba(10, 8, 6, 0.8);
      padding: 1rem 2rem;
      border-radius: 12px;
      border: 1px solid rgba(212, 180, 85, 0.2);
      backdrop-filter: blur(5px);
      
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: none; /* Click-through when hidden */
    }

    .fullscreen-overlay.active:hover { cursor: default; } /* Show cursor when moving */
    .fullscreen-hover-zone:hover .fullscreen-controls {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .input-row { flex-direction: column; }
      #mandala-canvas { max-width: 85vw; max-height: 85vw; }
      .title { font-size: 1.5rem; }
    }
  </style>
</head>

<body>

  <div class="navbar">
    <a href="../index.html">Caldwell's Repository</a>
    <a href="../apocrypha.html">Apocrypha</a>
    <a href="../imogen.html">Imogen</a>
  </div>

  <div class="container">
    <div class="header-group">
      <h1 class="title">Mandala Generator</h1>
      <p class="subtitle">
        <strong>Phonetics define form; Elements define color.</strong><br>
        This tool translates your name into Tibetan phonetics to calculate the geometry (karmic seed). 
        Your date determines the elemental alchemy (Iron, Water, Wood, Fire, Earth) for the palette.
      </p>
    </div>

    <div class="input-group">
      <div class="input-row">
        <input type="text" class="text-input" id="seed-input" placeholder="Enter name..." autocomplete="off">
        <input type="date" class="date-input" id="date-input">
      </div>
      
      <div class="meta-display">
        <div class="meta-item">
          <span class="meta-label">Phonetic Seed</span>
          <span class="meta-value tibetan-font" id="tibetan-display"></span>
        </div>
        <div class="meta-item" style="text-align: right;">
          <span class="meta-label">Elemental Alignment</span>
          <span class="meta-value" id="element-display">Void</span>
        </div>
      </div>
    </div>

    <div class="canvas-wrapper">
      <canvas id="mandala-canvas" width="600" height="600"></canvas>
    </div>

    <div class="controls">
      <button class="btn" id="random-btn">Random Name</button>
      <button class="btn" id="animate-btn">Animate</button>
      
      <div class="speed-group">
        <button class="btn small" id="slower-btn">-</button>
        <span class="speed-display" id="speed-display">1.0x</span>
        <button class="btn small" id="faster-btn">+</button>
      </div>

      <button class="btn" id="bloom-btn">Bloom</button>
      <button class="btn" id="fullscreen-btn">Fullscreen</button>
      <button class="btn" id="save-btn">Save</button>
    </div>
  </div>

  <div class="fullscreen-overlay" id="fullscreen-overlay">
    <canvas id="fullscreen-canvas"></canvas>
    
    <div class="fullscreen-hover-zone">
      <div class="fullscreen-controls">
        <button class="btn small" id="fs-slower-btn">Slow</button>
        <span class="speed-display" id="fs-speed-display">1.0x</span>
        <button class="btn small" id="fs-faster-btn">Fast</button>
        <button class="btn" id="fs-exit-btn">Exit</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // 1. TIBETAN PHONETICS & NUMEROLOGY
    // ============================================

    const LATIN_TO_TIBETAN = {
      'a': '\u0F68', 'b': '\u0F56', 'c': '\u0F45', 'd': '\u0F51',
      'e': '\u0F7A', 'f': '\u0F55', 'g': '\u0F42', 'h': '\u0F67',
      'i': '\u0F72', 'j': '\u0F47', 'k': '\u0F40', 'l': '\u0F63',
      'm': '\u0F58', 'n': '\u0F53', 'o': '\u0F7C', 'p': '\u0F54',
      'q': '\u0F41', 'r': '\u0F62', 's': '\u0F66', 't': '\u0F4F',
      'u': '\u0F74', 'v': '\u0F5D', 'w': '\u0F5D', 'x': '\u0F6A',
      'y': '\u0F61', 'z': '\u0F5F', ' ': ' ',
      'sh': '\u0F64', 'th': '\u0F50', 'ph': '\u0F55', 'ts': '\u0F59'
    };

    function convertToTibetan(text) {
      if (!text) return "";
      let lower = text.toLowerCase();
      let result = "";
      for (let i = 0; i < lower.length; i++) {
        let char = lower[i];
        if (i < lower.length - 1) {
          const digraph = lower.slice(i, i+2);
          if (LATIN_TO_TIBETAN[digraph]) {
            result += LATIN_TO_TIBETAN[digraph];
            i++;
            continue;
          }
        }
        result += LATIN_TO_TIBETAN[char] || "";
      }
      return result;
    }

    function getNumericSeed(tibetanText) {
      if (!tibetanText) return 123456;
      let sum = 0;
      for (let i = 0; i < tibetanText.length; i++) sum += tibetanText.codePointAt(i);
      return sum;
    }

    function mulberry32(seed) {
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    // ============================================
    // 2. ELEMENTAL ALCHEMY (COLOR ENGINE)
    // ============================================

    const ELEMENTS = {
      METAL: { name: 'Metal', colors: ['#F0F0F0', '#B0C4DE', '#DAA520', '#778899'] }, // White/Silver/Gold/Slate
      WATER: { name: 'Water', colors: ['#102E4A', '#4682B4', '#00CED1', '#000000'] }, // Deep Blue/Teal/Black
      WOOD:  { name: 'Wood',  colors: ['#2E8B57', '#8FBC8F', '#228B22', '#556B2F'] }, // Forest/Sage/Olive
      FIRE:  { name: 'Fire',  colors: ['#8B0000', '#FF4500', '#FFA500', '#FFD700'] }, // Crimson/Red/Orange/Gold
      EARTH: { name: 'Earth', colors: ['#DAA520', '#8B4513', '#CD853F', '#F4A460'] }  // Gold/Brown/Ochre
    };

    function getElementFromDate(dateStr) {
      if (!dateStr) return { primary: ELEMENTS.METAL, secondary: ELEMENTS.FIRE, label: "Void" };
      
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const day = date.getDay(); // 0-6

      // Tibetan Element Calculation (Year ending digit)
      const lastDigit = year % 10;
      let primary;
      if (lastDigit <= 1) primary = ELEMENTS.METAL;
      else if (lastDigit <= 3) primary = ELEMENTS.WATER;
      else if (lastDigit <= 5) primary = ELEMENTS.WOOD;
      else if (lastDigit <= 7) primary = ELEMENTS.FIRE;
      else primary = ELEMENTS.EARTH;

      const secondary = [ELEMENTS.FIRE, ELEMENTS.WATER, ELEMENTS.FIRE, ELEMENTS.WATER, ELEMENTS.WOOD, ELEMENTS.METAL, ELEMENTS.EARTH][day];
      
      return { primary, secondary, label: `${primary.name} / ${secondary.name}` };
    }

    // ============================================
    // 3. MANDALA GEOMETRY ENGINE (3x3 VARIATION)
    // ============================================

    function generateParams(seed, elementData) {
      const rand = mulberry32(seed);
      
      // Color Palette Construction
      const p = elementData.primary.colors;
      const s = elementData.secondary.colors;
      const palette = [p[0], p[1], s[2], p[2], s[0]]; // Mix primary and secondary

      // 3x3 Composition Matrix
      // We derive structure indices from the seed
      const centerType = seed % 3;     // 0: Lotus, 1: Vajra Cross, 2: Seed/Void
      const midType = (seed >> 2) % 3; // 0: Palace, 1: Cosmic Rings, 2: Web
      const outerType = (seed >> 4) % 3; // 0: Fire, 1: Mountain, 2: Great Lotus

      // Complexity
      const ringCount = 3 + Math.floor(rand() * 4);
      const petals = [8, 12, 16, 24][seed % 4];

      // Generate Rings
      const rings = [];
      for(let i=0; i<ringCount; i++) {
        rings.push({
          r: 0.2 + (i/ringCount)*0.6,
          color: palette[Math.floor(rand()*5)],
          width: 1 + rand() * 3,
          style: Math.floor(rand() * 3) // 0: solid, 1: dots, 2: double
        });
      }

      return { seed, palette, centerType, midType, outerType, ringCount, petals, rings };
    }

    // --- Drawing Functions ---

    function drawMandala(ctx, w, h, params, phase) {
      const cx = w/2, cy = h/2;
      const radius = Math.min(w, h)/2 * 0.95;

      // Clear & Background
      ctx.fillStyle = '#080706';
      ctx.fillRect(0, 0, w, h);

      // 1. OUTER BOUNDARY
      drawOuterLayer(ctx, cx, cy, radius, params, phase);

      // 2. MIDDLE STRUCTURE
      drawMidLayer(ctx, cx, cy, radius * 0.85, params, phase);

      // 3. RINGS (Overlay on middle)
      if (params.midType !== 0) { // If palace, rings are inside. If cosmic, rings are dominant.
         params.rings.forEach((ring, i) => {
           drawRing(ctx, cx, cy, radius * 0.85 * ring.r, ring, phase, i);
         });
      }

      // 4. CENTER CORE
      drawCenterLayer(ctx, cx, cy, radius * 0.25, params, phase);
    }

    function drawOuterLayer(ctx, cx, cy, r, params, phase) {
      const color1 = params.palette[3];
      const color2 = params.palette[2];
      
      if (params.outerType === 0) { // FIRE CIRCLE
        const flames = 40;
        for(let i=0; i<flames; i++) {
          const a = (i/flames)*Math.PI*2 + phase*0.2;
          const fr = r * (0.95 + Math.sin(i*5 - phase*3)*0.05);
          ctx.beginPath();
          ctx.arc(cx + Math.cos(a)*fr, cy + Math.sin(a)*fr, r*0.1, 0, Math.PI*2);
          ctx.fillStyle = i%2 ? color1 : color2;
          ctx.fill();
        }
      } else if (params.outerType === 1) { // MOUNTAIN/VAJRA FENCE
        ctx.beginPath();
        const spikes = 32;
        for(let i=0; i<=spikes; i++) {
          const a = (i/spikes)*Math.PI*2 + phase*0.05;
          const rad = i%2 ? r : r*0.9;
          ctx.lineTo(cx + Math.cos(a)*rad, cy + Math.sin(a)*rad);
        }
        ctx.closePath();
        ctx.strokeStyle = color1;
        ctx.lineWidth = 3;
        ctx.stroke();
      } else { // GREAT LOTUS
        const petals = 24;
        for(let i=0; i<petals; i++) {
          const a = (i/petals)*Math.PI*2 + phase*0.1;
          drawPetal(ctx, cx, cy, r*0.9, a, r*0.15, color2, '#ffd700');
        }
      }
    }

    function drawMidLayer(ctx, cx, cy, r, params, phase) {
      if (params.midType === 0) { // SQUARE PALACE
        const size = r * 1.4;
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(phase * 0.05);
        ctx.lineWidth = 2;
        ctx.strokeStyle = params.palette[0];
        ctx.strokeRect(-size/2, -size/2, size, size);
        
        // Gates
        for(let i=0; i<4; i++) {
            ctx.rotate(Math.PI/2);
            ctx.fillStyle = params.palette[i%4];
            ctx.fillRect(-size/6, -size/2 - size/10, size/3, size/5);
        }
        ctx.restore();

      } else if (params.midType === 1) { // COSMIC (Just background rings)
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.strokeStyle = params.palette[1];
        ctx.lineWidth = 1;
        ctx.stroke();

      } else { // WEB
        const lines = 16;
        ctx.beginPath();
        for(let i=0; i<lines; i++) {
            const a = (i/lines)*Math.PI*2 + phase*0.1;
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
        }
        ctx.strokeStyle = params.palette[0];
        ctx.globalAlpha = 0.5;
        ctx.stroke();
        ctx.globalAlpha = 1;
      }
    }

    function drawCenterLayer(ctx, cx, cy, r, params, phase) {
      if (params.centerType === 0) { // LOTUS CENTER
        for(let i=0; i<params.petals; i++) {
           const a = (i/params.petals)*Math.PI*2 + phase*0.2;
           drawPetal(ctx, cx, cy, r, a, r*0.3, params.palette[0], params.palette[1]);
        }
        ctx.beginPath(); ctx.arc(cx,cy,r*0.3,0,Math.PI*2); ctx.fillStyle='#ffd700'; ctx.fill();
        
      } else if (params.centerType === 1) { // VAJRA CROSS
        const arms = 4;
        for(let i=0; i<arms; i++) {
            const a = (i/arms)*Math.PI*2 + phase*0.1;
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(a);
            ctx.fillStyle = params.palette[i%params.palette.length];
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.lineTo(r*0.5, r*0.2);
            ctx.lineTo(r, 0);
            ctx.lineTo(r*0.5, -r*0.2);
            ctx.fill();
            ctx.restore();
        }
        
      } else { // SEED/VOID
        ctx.beginPath();
        ctx.arc(cx, cy, r*0.8, 0, Math.PI*2);
        const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,r);
        grad.addColorStop(0, '#fff');
        grad.addColorStop(1, params.palette[1]);
        ctx.fillStyle = grad;
        ctx.fill();
        // Tibetan Syllable
        ctx.fillStyle = '#000';
        ctx.font = `${r}px 'Noto Serif Tibetan'`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('\u0F30', cx, cy);
      }
    }

    function drawPetal(ctx, cx, cy, dist, angle, width, fill, stroke) {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.quadraticCurveTo(dist*0.5, width, dist, 0);
      ctx.quadraticCurveTo(dist*0.5, -width, 0, 0);
      ctx.fillStyle = fill;
      ctx.fill();
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.restore();
    }

    function drawRing(ctx, cx, cy, r, ring, phase, idx) {
      ctx.strokeStyle = ring.color;
      ctx.lineWidth = ring.width;
      ctx.beginPath();
      if(ring.style === 1) { // Dots
        const dots = 30;
        for(let i=0; i<dots; i++) {
            const a = (i/dots)*Math.PI*2 + phase*(idx%2?0.1:-0.1);
            ctx.moveTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r);
            ctx.arc(cx+Math.cos(a)*r, cy+Math.sin(a)*r, ring.width, 0, Math.PI*2);
        }
        ctx.fillStyle=ring.color; ctx.fill();
      } else {
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.stroke();
      }
    }

    function applyBloom(source, destCtx) {
        destCtx.globalCompositeOperation = 'lighter';
        destCtx.filter = 'blur(20px)';
        destCtx.globalAlpha = 0.4;
        destCtx.drawImage(source, 0, 0);
        destCtx.filter = 'none';
        destCtx.globalAlpha = 1.0;
        destCtx.globalCompositeOperation = 'source-over';
    }

    // ============================================
    // UI LOGIC
    // ============================================

    const canvas = document.getElementById('mandala-canvas');
    const ctx = canvas.getContext('2d');
    const seedInput = document.getElementById('seed-input');
    const dateInput = document.getElementById('date-input');
    
    // Default Date = Today
    dateInput.valueAsDate = new Date();

    let currentParams = null;
    let isAnimating = false;
    let animId = null;
    let speed = 1.0;
    let bloom = false;
    let phase = 0;

    function update() {
      const name = seedInput.value || "Imogen";
      const date = dateInput.value;
      
      const tibetan = convertToTibetan(name);
      document.getElementById('tibetan-display').textContent = tibetan;
      
      const seed = getNumericSeed(tibetan);
      const elementData = getElementFromDate(date);
      document.getElementById('element-display').textContent = elementData.label;
      
      currentParams = generateParams(seed, elementData);
      
      if(!isAnimating) drawMandala(ctx, canvas.width, canvas.height, currentParams, phase);
    }

    function loop() {
      if(!isAnimating) return;
      phase += 0.005 * speed;
      
      // Main Canvas
      drawMandala(ctx, canvas.width, canvas.height, currentParams, phase);
      if(bloom) applyBloom(canvas, ctx);

      // Fullscreen Canvas (if active)
      if(fsOverlay.classList.contains('active')) {
         fsCanvas.width = window.innerWidth;
         fsCanvas.height = window.innerHeight;
         drawMandala(fsCtx, fsCanvas.width, fsCanvas.height, currentParams, phase);
         if(bloom) applyBloom(fsCanvas, fsCtx);
      }
      
      animId = requestAnimationFrame(loop);
    }

    // Inputs
    seedInput.addEventListener('input', update);
    dateInput.addEventListener('change', update);
    
    // Random Name
    const names = ["Imogen", "Caldwell", "Tenzin", "Pema", "Dorje", "Lhamo", "Nyima", "Dawa"];
    document.getElementById('random-btn').addEventListener('click', () => {
      seedInput.value = names[Math.floor(Math.random()*names.length)];
      // Random date within 50 years
      const d = new Date();
      d.setFullYear(d.getFullYear() - Math.floor(Math.random()*50));
      dateInput.valueAsDate = d;
      update();
    });

    // Animation
    document.getElementById('animate-btn').addEventListener('click', function() {
      isAnimating = !isAnimating;
      this.textContent = isAnimating ? "Stop" : "Animate";
      if(isAnimating) loop();
      else cancelAnimationFrame(animId);
    });

    // Speed (Increased range up to 10x)
    const speeds = [0.5, 1.0, 2.0, 4.0, 8.0, 10.0];
    function changeSpeed(dir) {
      let idx = speeds.indexOf(speed);
      if(idx === -1) idx = 1;
      idx = Math.max(0, Math.min(speeds.length-1, idx + dir));
      speed = speeds[idx];
      document.getElementById('speed-display').textContent = speed + 'x';
      document.getElementById('fs-speed-display').textContent = speed + 'x';
    }
    document.getElementById('slower-btn').addEventListener('click', () => changeSpeed(-1));
    document.getElementById('faster-btn').addEventListener('click', () => changeSpeed(1));
    document.getElementById('fs-slower-btn').addEventListener('click', () => changeSpeed(-1));
    document.getElementById('fs-faster-btn').addEventListener('click', () => changeSpeed(1));

    // Bloom
    document.getElementById('bloom-btn').addEventListener('click', function() {
      bloom = !bloom;
      this.style.borderColor = bloom ? '#ffd700' : '';
      if(!isAnimating) update();
    });

    // Save
    document.getElementById('save-btn').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'mandala.png';
      link.href = canvas.toDataURL();
      link.click();
    });

    // Fullscreen Logic
    const fsOverlay = document.getElementById('fullscreen-overlay');
    const fsCanvas = document.getElementById('fullscreen-canvas');
    const fsCtx = fsCanvas.getContext('2d');

    document.getElementById('fullscreen-btn').addEventListener('click', () => {
      fsOverlay.classList.add('active');
      if(!isAnimating) { // Force animate in FS
        isAnimating = true;
        document.getElementById('animate-btn').textContent = "Stop";
        loop();
      }
    });

    document.getElementById('fs-exit-btn').addEventListener('click', () => {
      fsOverlay.classList.remove('active');
    });
    
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && fsOverlay.classList.contains('active')) {
        fsOverlay.classList.remove('active');
      }
    });

    // Init
    update();

  </script>
</body>
</html>
