<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Shopify Import Filler (fixed PLGGR layout)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; background:#0f1115; color:#e6e6e6; margin:0; padding:20px; }
    h1 { margin:0 0 8px; }
    label { display:block; margin-top:12px; }
    input[type="file"], input[type="text"] { width:100%; max-width:560px; }
    button { margin-top:16px; padding:10px 14px; border:0; border-radius:8px; background:#2b6cb0; color:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    pre { background:#171a21; border:1px solid #2a2f3a; border-radius:8px; padding:12px; white-space:pre-wrap; margin-top:14px; color:#cfd2d6; }
  </style>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Shopify Import Filler</h1>
  <p>
    Inputs:<br>
    A) Shopify skeleton (3-row format)<br>
    B) SKU → Identification map<br>
    C) PLGGR export (SKU=A, Title=AE, Description=AG)<br>
    Output: skeleton filled in column H (Translated content).
  </p>

  <label>A) Shopify skeleton (.xlsx)</label>
  <input id="skeleton" type="file" accept=".xlsx">

  <label>B) SKU → Identification map (.xlsx)</label>
  <input id="skuIdent" type="file" accept=".xlsx">

  <label>C) PLGGR export (.xlsx)</label>
  <input id="plggr" type="file" accept=".xlsx">

  <label>Locale code</label>
  <input id="locale" type="text" value="de">

  <button id="process" disabled>Generate Filled XLSX</button>
  <pre id="report"></pre>

<script>
const $ = id => document.getElementById(id);
let fSkeleton=null, fSkuIdent=null, fPlggr=null;

['skeleton','skuIdent','plggr'].forEach(id=>{
  $(id).addEventListener('change', e=>{
    if (id==='skeleton') fSkeleton=e.target.files[0];
    if (id==='skuIdent') fSkuIdent=e.target.files[0];
    if (id==='plggr')   fPlggr=e.target.files[0];
    $('process').disabled = !(fSkeleton && fSkuIdent && fPlggr);
  });
});

function sheetToAOA(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
      resolve(aoa);
    };
    r.onerror=reject;
    r.readAsArrayBuffer(file);
  });
}

function normaliseSKU(s){
  return String(s||'').trim().replace(/^0+/, '') || '0';
}

$('process').addEventListener('click', async ()=>{
  const [skeletonAOA, skuIdentAOA, plggrAOA] = await Promise.all([
    sheetToAOA(fSkeleton), sheetToAOA(fSkuIdent), sheetToAOA(fPlggr)
  ]);
  const locale = $('locale').value.trim();

  // Build SKU → Identification
  const skuToIdent=new Map();
  for (let i=1;i<skuIdentAOA.length;i++){
    const r=skuIdentAOA[i]; if (!r) continue;
    const sku=normaliseSKU(r[0]); const ident=String(r[1]||'').trim();
    if (sku && ident) skuToIdent.set(sku, ident);
  }

  // Build Identification → {title, body}
  const identToContent=new Map();
  for (let i=1;i<plggrAOA.length;i++){
    const row=plggrAOA[i]; if (!row) continue;
    const sku=normaliseSKU(row[0]);
    const ident=skuToIdent.get(sku); if (!ident) continue;
    const title=String(row[30]||'').trim(); // AE = col 30 (0-based)
    const body =String(row[32]||'').trim(); // AG = col 32 (0-based)
    if (!identToContent.has(ident)) identToContent.set(ident,{title:'',body:''});
    const o=identToContent.get(ident);
    if (title) o.title=title;
    if (body)  o.body =body;
  }

  // Fill skeleton
  const out=skeletonAOA.map(r=>r?r.slice():r);
  const header=out[0];
  const idx={Type:0, Identification:1, Field:2, Locale:3, Market:4, Status:5, Default:6, Translated:7};

  let filledTitle=0, filledBody=0;
  for (let i=1;i<out.length;i++){
    const row=out[i]; if (!row) continue;
    if (String(row[idx.Type]).toUpperCase()!=='PRODUCT') continue;
    const ident=String(row[idx.Identification]||'').trim();
    const field=String(row[idx.Field]||'').trim().toLowerCase();
    const content=identToContent.get(ident);
    if (locale) row[idx.Locale]=locale;
    if (field==='title' && content?.title){
      row[idx.Translated]=content.title; filledTitle++;
    }
    if (field==='body_html' && content?.body){
      row[idx.Translated]=content.body; filledBody++;
    }
  }

  const ws=XLSX.utils.aoa_to_sheet(out);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Shopify Import");
  XLSX.writeFile(wb,"shopify_import_filled.xlsx");

  $('report').textContent=
    `Titles filled: ${filledTitle}\nDescriptions filled: ${filledBody}\nTotal products mapped: ${identToContent.size}`;
});
</script>
</body>
</html>
