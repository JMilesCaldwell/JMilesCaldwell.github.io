<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Isekai Protagonist Generator</title>
  <link rel="icon" href="/resources/compass_favicon_32x32.png" type="image/png">
  <!-- GOOGLE FONTS -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Almendra&family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  >

  <style>
    /* BASIC STYLES */
    body {
      margin: 0;
      background: url('resources/isekaid.png') no-repeat center center fixed;
      background-size: cover;
      color: #FAF4E0;
      font-family: 'Almendra', serif;
      text-align: center;
    }
    h1, h2, h3 {
      font-family: 'Cinzel', serif;
      margin-bottom: 0.5rem;
    }
    .fancy-divider {
      margin: 0.25rem 0 1rem;
      font-size: 1.2rem;
      text-align: center;
    }
    .fancy-divider::after {
      content: "✦ ✧ ✦";
      color: #4B0082;
      letter-spacing: 0.5rem;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: rgba(0, 0, 0, 0.7);
      padding: 2rem;
      border-radius: 10px;
    }
    label {
      display: inline-block;
      width: 150px;
      margin-right: 8px;
      font-weight: bold;
    }
    select, input[type="text"], input[type="number"] {
      margin-bottom: 1rem;
      padding: 0.2rem;
      font-size: 1rem;
      background-color: #fff9ed;
      color: #333;
      border: 1px solid #999;
      font-family: 'Almendra', serif;
    }
    .button {
      background-color: #4B0082;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0;
      font-family: 'Cinzel', serif;
    }
    .button:hover {
      background-color: #2E0854;
    }
    .output {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #aaa;
      background-color: #fff5e6;
      color: #333;
    }
    .footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #666;
      font-family: 'Almendra', serif;
    }
    .isekai-note {
      background: rgba(75, 0, 130, 0.3);
      border: 1px dashed #9370DB;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
    }
    /* Hide print button until a character is generated */
    #printButton {
      display: none;
    }
    @media print {
      @page {
        margin: 0.75in;
        size: letter;
      }
      body {
        background: none !important;
        background-color: white !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      body * {
        visibility: hidden !important;
      }
      #output, #output * {
        visibility: visible !important;
      }
      #output {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 100%;
        padding: 0 !important;
        margin: 0 !important;
        background: white !important;
        border: none !important;
        box-sizing: border-box;
        font-size: 11pt;
        line-height: 1.4;
        color: #000 !important;
      }
      #output h2, #output h3 {
        color: #000 !important;
        page-break-after: avoid;
      }
      #output .fancy-divider::after {
        color: #333 !important;
      }
      #output hr {
        border-color: #333 !important;
        page-break-after: avoid;
      }
      #output ul {
        page-break-inside: avoid;
      }
      #printButton {
        display: none !important;
      }
    }
    /* Checkbox container styles */
    .feats-wrapper {
      text-align: left;
      display: inline-block;
      max-width: 600px;
    }
    #human-features-container, #isekai-traits-container {
      background: rgba(75, 0, 130, 0.2);
      padding: 0.75rem;
      border-radius: 5px;
      margin-top: 0.5rem;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
    }
    #human-features-container label, #isekai-traits-container label {
      cursor: pointer;
      display: block;
      margin-bottom: 0.3rem;
    }
    #human-features-container input[type="checkbox"], #isekai-traits-container input[type="checkbox"] {
      margin-right: 0.5rem;
      cursor: pointer;
    }
    /* Custom scrollbar for traits container */
    #isekai-traits-container::-webkit-scrollbar {
      width: 8px;
    }
    #isekai-traits-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    #isekai-traits-container::-webkit-scrollbar-thumb {
      background: #4B0082;
      border-radius: 4px;
    }
    #isekai-traits-container::-webkit-scrollbar-thumb:hover {
      background: #2E0854;
    }
    #manual-entry {
      background: rgba(75, 0, 130, 0.2);
      padding: 1rem;
      border-radius: 5px;
      display: inline-block;
    }
    #manual-entry label {
      width: 45px;
      text-align: right;
      margin-right: 5px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Isekai Protagonist Generator</h1>
  <div class="fancy-divider"></div>

  <!-- NAVIGATION BUTTONS -->
  <button class="button" onclick="window.location.href='https://jmilescaldwell.github.io/index.html'">
    Home
  </button>
  <button class="button" onclick="window.location.href='isekaidcards.html'">
    Level Up
  </button>

  <div class="isekai-note">
    <p>
      <em>"You were just an ordinary person going about your day... until Truck-kun sent you to a fantasy realm."</em>
    </p>
    <p>
      Generate a character with real-world skills transplanted into a fantasy setting.
    </p>
  </div>

  <!-- CHARACTER CREATION FORM -->
  <div id="creation-form">
    <!-- Character Name -->
    <div>
      <label for="firstname-input">First Name:</label>
      <input type="text" id="firstname-input" placeholder="e.g. Barry" />
    </div>
    <div>
      <label for="lastname-input">Last Name:</label>
      <input type="text" id="lastname-input" placeholder="e.g. van der Heiden" />
    </div>
    <!-- Optional Nickname -->
    <div>
      <label for="nickname-input">Nickname:</label>
      <input type="text" id="nickname-input" placeholder="Optional" />
    </div>
    <!-- Background Selection -->
    <div>
      <label for="background-select">Former Job:</label>
      <select id="background-select">
        <option value="">-- Choose --</option>
      </select>
      <button class="button" onclick="randomBackground()">Random</button>
    </div>
    <!-- Level Selection -->
    <div>
      <label for="level-select">Level:</label>
      <select id="level-select" onchange="updateClassOptions()">
        <option value="0">0 (Just Arrived)</option>
        <option value="0.5">0.5 (Adapting)</option>
        <option value="1">1 (Choose a Path)</option>
        <option value="2">2 (Specialization)</option>
      </select>
    </div>
    <!-- Class Path Selection (Level 1+) -->
    <div id="path-selection" style="display: none;">
      <label for="path-select">Path:</label>
      <select id="path-select" onchange="updateSpecOptions()">
        <option value="">-- Choose Path --</option>
        <option value="Path of the Warrior">Path of the Warrior</option>
        <option value="Path of the Mage">Path of the Mage</option>
        <option value="Path of the Rogue">Path of the Rogue</option>
      </select>
      <button class="button" onclick="randomPath()">Random</button>
    </div>
    <!-- Specialization Selection (Level 2) -->
    <div id="spec-selection" style="display: none;">
      <label for="spec-select">Specialization:</label>
      <select id="spec-select">
        <option value="">-- Choose Specialization --</option>
      </select>
      <button class="button" onclick="randomSpec()">Random</button>
    </div>
    <!-- Ability Scores -->
    <div>
      <label>Ability Scores:</label><br/>
      <button class="button" onclick="rollAbilityScores()">Roll (4d6 drop lowest)</button>
      <button class="button" onclick="standardArray()">Standard Array (15,14,13,12,10,8)</button>
      <button class="button" onclick="showManualEntry()">Manual Entry</button>
      <div id="abilities-display" style="margin-top:0.5rem;"></div>
      <div id="manual-entry" style="display:none; margin-top:0.5rem;">
        <div style="display: inline-block; text-align: left;">
          <label style="width:40px;">STR:</label><input type="number" id="manual-str" min="3" max="20" value="10" style="width:50px;"/><br/>
          <label style="width:40px;">DEX:</label><input type="number" id="manual-dex" min="3" max="20" value="10" style="width:50px;"/><br/>
          <label style="width:40px;">CON:</label><input type="number" id="manual-con" min="3" max="20" value="10" style="width:50px;"/><br/>
          <label style="width:40px;">INT:</label><input type="number" id="manual-int" min="3" max="20" value="10" style="width:50px;"/><br/>
          <label style="width:40px;">WIS:</label><input type="number" id="manual-wis" min="3" max="20" value="10" style="width:50px;"/><br/>
          <label style="width:40px;">CHA:</label><input type="number" id="manual-cha" min="3" max="20" value="10" style="width:50px;"/><br/>
        </div>
        <button class="button" onclick="applyManualScores()">Apply Scores</button>
      </div>
    </div>

    <!-- Human Features (Optional) -->
    <div class="feats-wrapper" style="margin-top:1rem;">
      <strong>Feats (Optional):</strong><br/>
      <div id="human-features-container"></div>
      <div id="isekai-traits-container"></div>
    </div>

    <!-- Generate Character & Full Random -->
    <div style="margin-top:1rem;">
      <button class="button" onclick="generateCharacter()">Generate Character</button>
      <button class="button" onclick="fullRandom()">Full Random</button>
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output" class="output" style="display: none;">
    <h2 id="charName" style="margin-top: 0;"></h2>
    <div class="fancy-divider"></div>
    <div id="charRaceInfo"></div>
    <div id="charBackground"></div>
    <div id="charAbilityScores"></div>
    <div id="charProficiencies"></div>
    <div id="charLanguages"></div>
    <div id="charEquipment"></div>
    <div id="charClass" style="margin-top:1rem;"></div>
    <hr/>
    <div id="charSelectedFeatures" style="margin-top:1rem;"></div>
    <div id="charTraits" style="margin-top:1rem;"></div>
  </div>

  <!-- PRINT BUTTON -->
  <button class="button" id="printButton" onclick="window.print()">Print</button>

  <!-- OGL NOTICE -->
  <div class="footer">
    <h3>Open Game License</h3>
    <p>
      This work includes material taken from the 5e System Reference Document (SRD),
      © 2016, Wizards of the Coast, Inc. and is covered by the
      <strong>Open Game License, Version 1.0a</strong>.
      <br/><br/>
      <em>
      OPEN GAME LICENSE Version 1.0a<br>
      The following text is the property of Wizards of the Coast, Inc. and is Copyright
      2000 Wizards of the Coast, Inc ("Wizards"). All Rights Reserved.<br>
      1. Definitions: (a)"Contributors" means the copyright...
      <a href="https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" target="_blank">Read the full license</a>.
      </em>
    </p>
  </div>
</div>

<script>
  // ---------- Global Arrays and Constants ----------

  // ---------- Human (Default Race) ----------
  const HUMAN_DATA = {
    name: "Human",
    abilityScoreBonuses: { STR: 1, DEX: 1, CON: 1, INT: 1, WIS: 1, CHA: 1 },
    speed: 30,
    languages: ["Common", "One Extra Language of your choice"]
  };

  // Optional human features (checkboxes)
  const HUMAN_FEATURES = [
    { id: "isekai-protagonist", name: "Isekai Protagonist", desc: "You have vague memories of another world and occasionally reference things no one understands." },
    { id: "adaptable", name: "Adaptable", desc: "You learn new things quickly. Gain proficiency in one additional skill of your choice." }
  ];

  // ---------- Isekai Traits (Optional) ----------
  const ISEKAI_TRAITS = [
    {
      id: "middle-managers-eye",
      name: "Middle Manager's Eye",
      desc: "You have Advantage on Insight checks when dealing with merchants or nobles. You can accurately estimate the gold value of any mundane item at a glance."
    },
    {
      id: "culinary-nostalgia",
      name: "Culinary Nostalgia",
      desc: "During a long rest, you can prepare a meal using 'exotic' techniques (stir-fry, seasoning, actual hygiene). Those who eat it gain Temporary HP equal to your level + your Charisma modifier."
    },
    {
      id: "sanitation-specialist",
      name: "Sanitation Specialist",
      desc: "You have Advantage on Saving Throws against Diseases and Poisons. You can spend 1 hour teaching a village basic hygiene to increase their 'Development Level.'"
    },
    {
      id: "button-masher",
      name: "Button Masher's Reflexes",
      desc: "Years of gaming have given you supernatural finger dexterity. You have Advantage on Sleight of Hand checks and can perform simple object interactions as a bonus action."
    },
    {
      id: "loot-goblin",
      name: "Loot Goblin",
      desc: "You instinctively check every container, body, and suspicious floor tile. You have Advantage on Investigation checks to find hidden items and can carry 50% more weight."
    },
    {
      id: "immovable-object",
      name: "Immovable Object",
      desc: "You cannot be moved against your will by any effect that would push, pull, or drag you. Stubborn to a fault, you've simply decided you're not moving."
    },
    {
      id: "quick-save-instincts",
      name: "Quick-Save Instincts",
      desc: "You have an uncanny sense for when things are about to go wrong. Once per long rest, when you fail a saving throw, you may reroll it (you must use the new result)."
    },
    {
      id: "meta-gamer",
      name: "Meta Gamer",
      desc: "You recognize tropes and patterns. You have Advantage on checks to predict enemy behavior, spot obvious traps, and identify 'that one suspicious NPC.'"
    },
    {
      id: "inventory-tetris",
      name: "Inventory Tetris Master",
      desc: "You can fit an improbable amount of items into containers. Your carrying capacity is doubled, and you can retrieve any stored item as a free action."
    },
    {
      id: "respawn-mentality",
      name: "Respawn Mentality",
      desc: "You're weirdly calm about mortal danger because part of you still doesn't believe this is real. You are immune to the Frightened condition."
    },
    {
      id: "min-maxer",
      name: "Min-Maxer's Mind",
      desc: "You instinctively optimize everything. Once per short rest, you may add your proficiency bonus to a roll you weren't proficient in."
    },
    {
      id: "speedrunner",
      name: "Speedrunner's Intuition",
      desc: "You have an eye for shortcuts and exploits. Your movement speed increases by 10 feet, and you have Advantage on checks to find alternate routes."
    },
    {
      id: "rage-quit-resilience",
      name: "Rage-Quit Resilience",
      desc: "You've experienced countless frustrating defeats. When you drop to 0 HP, you may use your reaction to stay at 1 HP instead. Once per long rest."
    },
    {
      id: "tutorial-skipper",
      name: "Tutorial Skipper",
      desc: "You learn by doing, not listening. You have Advantage on checks to figure out how things work without instruction, but Disadvantage on checks to recall spoken instructions."
    },
    {
      id: "patch-notes-reader",
      name: "Patch Notes Reader",
      desc: "You notice when things change. You automatically detect illusions, shapechangers, or anything 'not quite right' within 30 feet (passive Perception applies)."
    },
    {
      id: "grind-mentality",
      name: "Grind Mentality",
      desc: "Repetitive tasks don't bore you - they're just farming. You don't suffer exhaustion from performing the same mundane task repeatedly and work 50% faster on repetitive crafting."
    },
    {
      id: "back-pain",
      name: "Back Pain",
      desc: "Your back is absolutely fucked. You have disadvantage on Athletics checks involving lifting or carrying, but you've learned to work around it. You can use DEX instead of STR for any check that doesn't involve raw lifting power. Also, you can predict weather changes 1 hour in advance with perfect accuracy."
    }
  ];

  // ---------- Backgrounds (Isekai Jobs) ----------
  const BACKGROUNDS = [
    {
      name: "Contractor",
      skillProficiencies: ["Athletics", "Investigation", "Survival", "Chunky Lover"],
      languages: [],
      equipment: [
        "Carpenter's tools",
        "Coil of measuring rope",
        "Worn leather tool belt",
        "Strange rectangular device that no longer works (smartphone)",
        "Set of sturdy work clothes",
        "Belt pouch containing 12 gp"
      ],
      feature: "Master Builder",
      featureDesc: "Your knowledge of construction, plumbing, and HVAC systems from another world gives you an intuitive understanding of structures. You can assess building integrity at a glance, jury-rig heating/cooling solutions using available materials, and instinctively understand air flow and insulation. You have advantage on checks to repair or sabotage structures.",
      bonuses: {
        description: "Climate Control Expert: You can create basic heating or cooling solutions with 1 hour of work and appropriate materials, providing comfort in extreme temperatures. Chunky Lover: You have proficiency in appreciating thicc individuals and gain advantage on Charisma checks when interacting with them.",
        survivalBonus: true
      }
    },
    {
      name: "Customer Service Worker",
      skillProficiencies: ["Persuasion", "Insight", "Performance", "Weaponized Autism"],
      languages: [],
      equipment: [
        "Faded hoodie with mysterious logo",
        "Notebook of complaints and requests",
        "Stress ball (strange squeezable orb)",
        "Name tag that says 'TRAINEE'",
        "Set of common clothes",
        "Belt pouch containing 6 gp"
      ],
      feature: "Unshakeable Composure",
      featureDesc: "Years of dealing with impossible customers have forged your soul into unbreakable steel. You have advantage on Wisdom saving throws against being frightened, charmed, or intimidated. When someone attempts to provoke you, you may choose to respond with aggressive corporate politeness, imposing disadvantage on their next Charisma check.",
      bonuses: {
        description: "Dead Inside (in a good way): You are immune to the frightened condition caused by creatures of CR 1 or lower. You've seen worse. Weaponized Autism: Your hyperfocus and pattern recognition are unmatched. You have advantage on Investigation checks to notice inconsistencies and can recall obscure details with perfect clarity.",
        wisdomSaveBonus: 2
      }
    },
    {
      name: "Unemployed",
      skillProficiencies: ["Perception", "Sleight of Hand", "Smoke Weed", "A Bit of a Cunt"],
      languages: [],
      equipment: [
        "Half-empty lighter",
        "Crumpled pack with two cigarettes left",
        "Stained hoodie (formerly black)",
        "Phone charger (no phone)",
        "Expired bus pass",
        "Pocket lint and 3 copper pieces"
      ],
      feature: "Professional Napper",
      featureDesc: "You've mastered the art of doing absolutely nothing productive. You can fall asleep anywhere within 1 minute and gain the benefits of a short rest in half the normal time. You have advantage on saving throws against effects that would compel you to work or be productive.",
      bonuses: {
        description: "Smoke Weed: You have proficiency in identifying, appraising, and consuming various herbs. You're immune to the poisoned condition from inhaled substances. A Bit of a Cunt: Your complete lack of filter occasionally works in your favor. Once per long rest, when you fail a Charisma check, you may reroll it - your brutal honesty sometimes comes across as refreshing.",
        constitutionBonus: 1
      }
    }
  ];

  // ---------- Class Progression System ----------
  // Level 1 Paths
  const CLASS_PATHS = {
    "Path of the Warrior": {
      description: "You've begun training in martial combat, learning to wield weapons with deadly precision.",
      hitDie: "d10",
      proficiencies: {
        armor: ["Light armor", "Medium armor", "Shields"],
        weapons: "martial",
        savingThrows: ["STR", "CON"],
        skills: ["Athletics", "Intimidation"]
      },
      features: [
        "Fighting Style: Choose one - Defense (+1 AC), Dueling (+2 damage with one-handed), or Great Weapon Fighting (reroll 1s and 2s on damage)",
        "Second Wind: Once per short rest, bonus action to regain 1d10 + 1 HP"
      ],
      extraHP: 4,
      nextLevel: ["Knight", "Berserker"]
    },
    "Path of the Mage": {
      description: "You've awakened to the arcane arts, channeling magical energy through sheer force of will.",
      hitDie: "d6",
      proficiencies: {
        armor: [],
        weapons: "simple",
        savingThrows: ["INT", "WIS"],
        skills: ["Arcana", "Investigation"]
      },
      features: [
        "Spellcasting: You know 3 cantrips (Fire Bolt, Mage Hand, Prestidigitation)",
        "Arcane Recovery: Once per day, recover one spell slot on a short rest",
        "Spell Slots: 2 first-level slots"
      ],
      spells: {
        cantrips: ["Fire Bolt (1d10 fire, 120ft)", "Mage Hand", "Prestidigitation"],
        level1: ["Magic Missile", "Shield", "Detect Magic"]
      },
      extraHP: 2,
      nextLevel: ["Wizard", "Necromancer"]
    },
    "Path of the Rogue": {
      description: "You've learned to strike from the shadows, using cunning and precision over brute force.",
      hitDie: "d8",
      proficiencies: {
        armor: ["Light armor"],
        weapons: "simple",
        savingThrows: ["DEX", "INT"],
        skills: ["Stealth", "Sleight of Hand", "Perception"]
      },
      features: [
        "Sneak Attack: +1d6 damage when you have advantage or an ally is adjacent to target",
        "Expertise: Double proficiency bonus on two skills (Stealth, Sleight of Hand)",
        "Thieves' Cant: Secret language of rogues"
      ],
      extraHP: 3,
      nextLevel: ["Assassin", "Thief"]
    }
  };

  // Level 2 Specializations
  const CLASS_SPECIALIZATIONS = {
    // Warrior Specializations
    "Knight": {
      parentPath: "Path of the Warrior",
      description: "A noble warrior who protects allies and upholds honor on the battlefield.",
      features: [
        "Action Surge: Once per short rest, take an additional action",
        "Protection Fighting Style: Use reaction to impose disadvantage on attacks against adjacent allies",
        "Rallying Cry: Bonus action to grant ally temporary HP equal to your level"
      ],
      extraHP: 6,
      bonusAC: 1
    },
    "Berserker": {
      parentPath: "Path of the Warrior",
      description: "A fury-driven fighter who channels rage into devastating attacks.",
      features: [
        "Rage: Bonus action to enter rage - advantage on STR checks, +2 melee damage, resistance to bludgeoning/piercing/slashing (2/long rest)",
        "Reckless Attack: Gain advantage on attacks but attacks against you have advantage",
        "Danger Sense: Advantage on DEX saves against effects you can see"
      ],
      extraHP: 8,
      bonusDamage: 2
    },
    // Mage Specializations
    "Wizard": {
      parentPath: "Path of the Mage",
      description: "A scholarly mage who masters the arcane through study and intellect.",
      features: [
        "Arcane Tradition: Evocation - Sculpt Spells around allies",
        "Spell Slots: 3 first-level slots",
        "New Spells Known: Burning Hands, Thunderwave, Chromatic Orb"
      ],
      spells: {
        cantrips: ["Fire Bolt (1d10 fire)", "Mage Hand", "Prestidigitation", "Ray of Frost (1d8 cold)"],
        level1: ["Magic Missile", "Shield", "Detect Magic", "Burning Hands", "Thunderwave", "Chromatic Orb"]
      },
      extraHP: 4
    },
    "Necromancer": {
      parentPath: "Path of the Mage",
      description: "A mage who dabbles in the forbidden arts of death and undeath.",
      features: [
        "Grim Harvest: When you kill a creature with a spell, regain HP equal to twice the spell's level",
        "Undead Thralls: Animate Dead creates undead with extra HP and damage",
        "New Spells Known: False Life, Ray of Sickness, Cause Fear"
      ],
      spells: {
        cantrips: ["Chill Touch (1d8 necrotic)", "Mage Hand", "Prestidigitation", "Spare the Dying"],
        level1: ["Magic Missile", "Shield", "False Life", "Ray of Sickness", "Cause Fear"]
      },
      extraHP: 4
    },
    // Rogue Specializations
    "Assassin": {
      parentPath: "Path of the Rogue",
      description: "A deadly killer who strikes before enemies know they're in danger.",
      features: [
        "Assassinate: Advantage on attacks against creatures that haven't acted. Hits against surprised creatures are critical hits",
        "Sneak Attack: +2d6 damage (increased from 1d6)",
        "Infiltration Expertise: Create false identities with a week of preparation"
      ],
      extraHP: 5,
      sneakAttackDice: "2d6"
    },
    "Thief": {
      parentPath: "Path of the Rogue",
      description: "A nimble scoundrel who excels at infiltration and acquiring 'lost' items.",
      features: [
        "Fast Hands: Use Sleight of Hand, disarm traps, or pick locks as a bonus action",
        "Second-Story Work: Climbing costs no extra movement. Running jumps increase by DEX modifier feet",
        "Supreme Sneak: Advantage on Stealth checks if you move no more than half speed"
      ],
      extraHP: 5,
      bonusSkills: ["Acrobatics"]
    }
  };

  // ---------- Personality Traits ----------
  const PERSONALITY_TRAITS = [
    "I constantly compare everything to how it was 'back home' and find this world lacking.",
    "I'm convinced I'm the protagonist of some grand story and act accordingly.",
    "I miss modern conveniences terribly and complain about the lack of indoor plumbing.",
    "I try to introduce concepts from my world, usually with disastrous results.",
    "I'm surprisingly calm about being in another world - it's better than my old job anyway.",
    "I keep expecting to find a 'system' or 'status screen' and am disappointed it hasn't appeared.",
    "I've accepted my fate and am determined to make the best of this new life.",
    "I'm convinced there must be a way back and obsessively search for it.",
    "I treat dangerous situations like customer complaints - with forced cheerfulness.",
    "I have an uncanny ability to stay calm that unnerves people around me.",
    "I unconsciously use phrases and references no one in this world understands.",
    "I'm weirdly overqualified for simple tasks but hilariously underqualified for combat.",
    "I keep trying to explain 'health and safety regulations' to adventurers.",
    "I miss coffee more than anything and will do almost anything for a similar stimulant.",
    "I have oddly specific knowledge that occasionally proves incredibly useful.",
    "I treat every problem like a work assignment and try to find the most efficient solution.",
    "I'm used to being underappreciated and am shocked when people thank me sincerely.",
    "I instinctively try to find the manager when things go wrong.",
    "I have a thousand-yard stare that comes from years of customer service.",
    "I'm far too comfortable with chaos and dysfunction - this world feels familiar.",
    "I keep a mental tally of complaints I'd file if HR existed here.",
    "I default to customer service voice when stressed, which confuses everyone.",
    "I have unreasonably good conflict resolution skills from my previous career.",
    "I treat nobility like difficult customers and am somehow still alive."
  ];

  // ---------- Utility Functions ----------
  function populateSelect(selectId, optionsArray) {
    const selectElem = document.getElementById(selectId);
    optionsArray.forEach(opt => {
      const optionEl = document.createElement("option");
      optionEl.value = opt;
      optionEl.innerText = opt;
      selectElem.appendChild(optionEl);
    });
  }

  function pickRandom(array) {
    return array[Math.floor(Math.random() * array.length)];
  }

  function pickMultipleDistinct(array, count) {
    const copy = [...array];
    const result = [];
    if (count > copy.length) count = copy.length;
    for (let i = 0; i < count; i++) {
      const index = Math.floor(Math.random() * copy.length);
      result.push(copy[index]);
      copy.splice(index, 1);
    }
    return result;
  }

  function roll4d6DropLowest() {
    let scores = [];
    for (let i = 0; i < 6; i++) {
      let rolls = [0, 0, 0, 0].map(() => Math.floor(Math.random() * 6) + 1);
      rolls.sort((a, b) => a - b);
      rolls.shift(); // drop lowest
      scores.push(rolls.reduce((acc, val) => acc + val, 0));
    }
    return scores;
  }

  function getStandardArray() {
    return [15, 14, 13, 12, 10, 8];
  }

  function abilityMod(score) {
    return Math.floor((score - 10) / 2);
  }


  // ---------- Background Randomiser ----------
  function randomBackground() {
    const randomPick = pickRandom(BACKGROUNDS).name;
    document.getElementById("background-select").value = randomPick;
  }

  // ---------- Class Path Functions ----------
  function updateClassOptions() {
    const level = document.getElementById("level-select").value;
    const pathDiv = document.getElementById("path-selection");
    const specDiv = document.getElementById("spec-selection");

    if (level === "1" || level === "2") {
      pathDiv.style.display = "block";
    } else {
      pathDiv.style.display = "none";
      specDiv.style.display = "none";
    }

    if (level === "2") {
      updateSpecOptions();
    } else {
      specDiv.style.display = "none";
    }
  }

  function updateSpecOptions() {
    const level = document.getElementById("level-select").value;
    const specDiv = document.getElementById("spec-selection");
    const specSelect = document.getElementById("spec-select");
    const selectedPath = document.getElementById("path-select").value;

    if (level === "2" && selectedPath) {
      specDiv.style.display = "block";
      // Clear and repopulate
      specSelect.innerHTML = '<option value="">-- Choose Specialization --</option>';
      const pathData = CLASS_PATHS[selectedPath];
      if (pathData && pathData.nextLevel) {
        pathData.nextLevel.forEach(spec => {
          const opt = document.createElement("option");
          opt.value = spec;
          opt.innerText = spec;
          specSelect.appendChild(opt);
        });
      }
    } else {
      specDiv.style.display = "none";
    }
  }

  function randomPath() {
    const paths = Object.keys(CLASS_PATHS);
    const randomPick = pickRandom(paths);
    document.getElementById("path-select").value = randomPick;
    updateSpecOptions();
  }

  function randomSpec() {
    const specSelect = document.getElementById("spec-select");
    const options = Array.from(specSelect.options).filter(o => o.value);
    if (options.length > 0) {
      specSelect.value = pickRandom(options).value;
    }
  }

  // ---------- Ability Score Handlers ----------
  let currentScores = [10, 10, 10, 10, 10, 10]; // default
  function rollAbilityScores() {
    currentScores = roll4d6DropLowest();
    displayScores();
  }

  function standardArray() {
    currentScores = getStandardArray();
    displayScores();
  }

  function displayScores() {
    const container = document.getElementById("abilities-display");
    const labels = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
    let html = "";
    currentScores.forEach((sc, i) => {
      const mod = abilityMod(sc);
      html += `${labels[i]}: <strong>${sc}</strong> (${mod >= 0 ? "+" : ""}${mod})<br/>`;
    });
    container.innerHTML = html;
  }

  function showManualEntry() {
    document.getElementById("manual-entry").style.display = "block";
    document.getElementById("abilities-display").innerHTML = "<em>Enter your scores below:</em>";
  }

  function applyManualScores() {
    currentScores = [
      parseInt(document.getElementById("manual-str").value) || 10,
      parseInt(document.getElementById("manual-dex").value) || 10,
      parseInt(document.getElementById("manual-con").value) || 10,
      parseInt(document.getElementById("manual-int").value) || 10,
      parseInt(document.getElementById("manual-wis").value) || 10,
      parseInt(document.getElementById("manual-cha").value) || 10
    ];
    document.getElementById("manual-entry").style.display = "none";
    displayScores();
  }

  // ---------- Weapons, Armours, and Proficiencies ----------
  const SIMPLE_WEAPONS = ["Club", "Dagger", "Handaxe", "Spear"];
  const IMPROVISED_WEAPON = "Improvised (like a club)";

  const WEAPON_DATA = {
    "Club":             { damageDie: "1d4", damageType: "bludgeoning", finesse: false, ranged: false },
    "Dagger":           { damageDie: "1d4", damageType: "piercing",    finesse: true,  ranged: false },
    "Handaxe":          { damageDie: "1d6", damageType: "slashing",    finesse: false, ranged: false },
    "Spear":            { damageDie: "1d6", damageType: "piercing",    finesse: false, ranged: false },
    "Improvised (like a club)": { damageDie: "1d4", damageType: "bludgeoning", finesse: false, ranged: false },
    "Pipe Wrench": { damageDie: "1d6", damageType: "bludgeoning", finesse: false, ranged: false },
    "Box Cutter": { damageDie: "1d4", damageType: "slashing", finesse: true, ranged: false },
    "Empty Bottle": { damageDie: "1d4", damageType: "bludgeoning", finesse: false, ranged: false }
  };

  // Skills grouped by ability score
  const SKILLS_BY_ABILITY = {
    STR: ["Athletics"],
    DEX: ["Acrobatics", "Sleight of Hand", "Stealth"],
    CON: [],
    INT: ["Arcana", "History", "Investigation", "Nature", "Religion"],
    WIS: ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"],
    CHA: ["Deception", "Intimidation", "Performance", "Persuasion"]
  };

  // Modern clothing layers - each piece adds to AC
  const MODERN_PANTS = [
    { name: "Cargo pants (lots of pockets)", acBonus: 1 },
    { name: "Sturdy work jeans", acBonus: 1 },
    { name: "Khakis with reinforced knees", acBonus: 1 },
    { name: "Tactical pants", acBonus: 1 },
    { name: "Worn-in Dickies", acBonus: 1 },
    { name: "Faded black jeans", acBonus: 1 },
    { name: "Carpenter pants with tool loops", acBonus: 1 },
    { name: "Weathered chinos", acBonus: 1 }
  ];

  const MODERN_SHIRTS = [
    { name: "Thick flannel shirt", acBonus: 1 },
    { name: "Durable work polo", acBonus: 1 },
    { name: "Long-sleeve henley", acBonus: 1 },
    { name: "Button-down oxford shirt", acBonus: 1 },
    { name: "Faded metal band t-shirt (illegible logo)", acBonus: 1 },
    { name: "Vintage Metallica shirt", acBonus: 1 },
    { name: "Black Sabbath tour shirt (1978)", acBonus: 1 },
    { name: "Slayer shirt that's seen better days", acBonus: 1 },
    { name: "Novelty shirt ('I'm not arguing, I'm explaining')", acBonus: 1 },
    { name: "Shirt that says 'I survived [illegible] 5K'", acBonus: 1 },
    { name: "Ironic graphic tee (wolves howling at moon)", acBonus: 1 },
    { name: "Company softball team shirt", acBonus: 1 },
    { name: "Plain black t-shirt", acBonus: 1 },
    { name: "Thermal undershirt", acBonus: 1 }
  ];

  const MODERN_SWEATERS = [
    { name: "Heavy knit sweater", acBonus: 1 },
    { name: "Faded company hoodie", acBonus: 1 },
    { name: "Thermal fleece pullover", acBonus: 1 },
    { name: "Worn zip-up sweatshirt", acBonus: 1 },
    { name: "Oversized college hoodie", acBonus: 1 },
    { name: "Quarter-zip fleece", acBonus: 1 },
    { name: "Ratty old cardigan", acBonus: 1 },
    { name: "Hoodie with thumb holes in sleeves", acBonus: 1 },
    { name: "Pullover with company logo", acBonus: 1 },
    { name: "Waffle-knit thermal", acBonus: 1 }
  ];

  const MODERN_JACKETS = [
    { name: "Carhartt work jacket", acBonus: 1 },
    { name: "Bomber jacket", acBonus: 1 },
    { name: "Leather jacket (well-worn)", acBonus: 1 },
    { name: "Black leather biker jacket", acBonus: 1 },
    { name: "Hardshell rain jacket", acBonus: 1 },
    { name: "Insulated puffer jacket", acBonus: 1 },
    { name: "High-vis safety vest over jacket", acBonus: 1 },
    { name: "Lined denim jacket", acBonus: 1 },
    { name: "Fleece-lined flannel jacket", acBonus: 1 },
    { name: "Windbreaker with broken zipper", acBonus: 1 },
    { name: "Canvas chore coat", acBonus: 1 },
    { name: "Quilted vest over long sleeves", acBonus: 1 }
  ];

  const MODERN_UNDERWEAR = [
    { name: "Boxers (cartoon print)", acBonus: 0 },
    { name: "Plain boxer briefs", acBonus: 0 },
    { name: "Tighty whities (classic)", acBonus: 0 },
    { name: "Novelty boxers (pizza pattern)", acBonus: 0 },
    { name: "Worn-out briefs", acBonus: 0 },
    { name: "Athletic compression shorts", acBonus: 0 },
    { name: "Boxers with holes (but clean!)", acBonus: 0 },
    { name: "Christmas boxers (it's not Christmas)", acBonus: 0 },
    { name: "Going commando", acBonus: 0 },
    { name: "Commando (bold choice)", acBonus: 0 },
    { name: "Long underwear (thermal)", acBonus: 0 },
    { name: "Lucky underwear (questionable)", acBonus: 0 }
  ];

  const MODERN_SHOES = [
    { name: "Steel-toe work boots", acBonus: 1 },
    { name: "Worn-in army boots", acBonus: 1 },
    { name: "Leather boots (scuffed)", acBonus: 1 },
    { name: "Timberlands (classic wheat)", acBonus: 1 },
    { name: "Red Wing work boots", acBonus: 1 },
    { name: "Hiking boots (muddy)", acBonus: 1 },
    { name: "Beat-up sneakers", acBonus: 1 },
    { name: "White sneakers (not white anymore)", acBonus: 1 },
    { name: "Black Converse All-Stars", acBonus: 1 },
    { name: "High-top Vans", acBonus: 1 },
    { name: "Running shoes (never ran)", acBonus: 1 },
    { name: "Slip-on Vans", acBonus: 1 },
    { name: "New Balance dad shoes", acBonus: 1 },
    { name: "Sandals with socks", acBonus: 1 },
    { name: "Birkenstock sandals", acBonus: 1 },
    { name: "Crocs (unironically)", acBonus: 1 },
    { name: "Chelsea boots", acBonus: 1 },
    { name: "Doc Martens (broken in)", acBonus: 1 }
  ];

  const BACKGROUND_WEAPONS = {
    "Contractor": ["Pipe Wrench", "Handaxe", IMPROVISED_WEAPON],
    "Customer Service Worker": ["Box Cutter", IMPROVISED_WEAPON],
    "Unemployed": ["Empty Bottle", IMPROVISED_WEAPON]
  };

  const BACKGROUND_PROFICIENCIES = {
    "Contractor": "simple",
    "Customer Service Worker": "simple",
    "Unemployed": "simple"
  };

  // Pocket dump items - random stuff found in pockets
  const POCKET_DUMP_ITEMS = [
    // Tech & electronics
    "Dead smartphone (cracked screen)", "Smartphone (2% battery, no signal)", "Tangled earbuds (one side works)",
    "USB drive with 'IMPORTANT' label", "Fitbit (stopped counting steps)", "Broken smartwatch",
    "Old flip phone (somehow still works)", "Charging cable (wrong type)", "Wireless earbud (just one)",

    // Wallet contents
    "Leather wallet (mostly empty)", "Velcro wallet (don't judge)", "Money clip with foreign currency",
    "Maxed-out credit card", "Expired driver's license", "Library card (3 years overdue)",
    "Gym membership card (never used)", "Loyalty card (2 stamps from free coffee)", "Old concert ticket stub",
    "Crumpled $20 bill", "Handful of foreign coins", "Gift card with $0.37 remaining",

    // Keys & accessories
    "Keychain with too many keys", "Car keys (no car in this world)", "House keys (no house either)",
    "Bottle opener keychain", "Mini flashlight (dead batteries)", "Carabiner with random keys",
    "Lanyard with work ID badge", "Keychain Swiss army knife", "Apartment fob (useless now)",

    // Lighters & smoking
    "Bic lighter (almost empty)", "Zippo lighter (out of fluid)", "Book of matches (damp)",
    "Vape pen (dead battery)", "Pack of gum (last piece)", "Tin of mints (mostly empty)",

    // Receipts & paper
    "Crumpled receipt (illegible)", "Grocery list from last week", "Parking ticket (unpaid)",
    "Post-it note with cryptic reminder", "Business card from someone you forgot", "Lottery ticket (not checked)",
    "Folded napkin with phone number", "Movie ticket stub", "Faded photograph",

    // Food & snacks
    "Leftover sandwich (questionable)", "Half-eaten granola bar", "Pocket full of crumbs",
    "Squished protein bar", "Emergency candy bar", "Bag of trail mix (just raisins left)",
    "Stale crackers in wrapper", "Melted chocolate (in wrapper, hopefully)", "Cold coffee in travel mug",

    // Personal items
    "Condom (expired)", "Chapstick (almost empty)", "Hand sanitizer (sticky)",
    "Crumpled tissues", "Hair tie (stretched out)", "Bobby pins (bent)",
    "Nail clippers", "Eye drops (expired)", "Ibuprofen (loose in pocket)",
    "Cough drops (lint-covered)", "Bandaids (old)", "Floss pick (used? unclear)",

    // Random objects
    "Pocket lint (impressive amount)", "Mystery key", "Rubber band ball",
    "Pen that doesn't work", "Sharpie (dried out)", "Tape measure (retractable)",
    "Random bolt (from what?)", "Button (origin unknown)", "Paper clip chain",
    "Fidget spinner (broken bearing)", "Stress ball (punctured)", "Lucky rock",
    "D20 die", "Guitar pick", "Bottle cap collection",

    // Work-related
    "Name tag ('TRAINEE')", "Punch card (halfway full)", "Break room schedule",
    "Safety glasses (scratched)", "Work gloves (hole in thumb)", "Pen from the bank",
    "Sticky notes (blank)", "Retractable badge holder", "Earplugs (foam, used)"
  ];

  function getRandomPocketDump(count = 3) {
    return pickMultipleDistinct(POCKET_DUMP_ITEMS, count);
  }

  // ---------- Weapon & Armour Calculations ----------
  function isProficientInWeapon(weaponName, backgroundName) {
    const cat = BACKGROUND_PROFICIENCIES[backgroundName];
    if (!cat) return false;
    if (SIMPLE_WEAPONS.includes(weaponName)) return (cat === "simple" || cat === "martial");
    // Pipe wrench and box cutter count as simple for proficiency
    if (weaponName === "Pipe Wrench" || weaponName === "Box Cutter") return true;
    return false;
  }

  function getRandomWeaponForBackground(bgName) {
    let weaponsArray = BACKGROUND_WEAPONS[bgName];
    if (!weaponsArray) weaponsArray = ["Club", "Dagger", IMPROVISED_WEAPON];
    return pickRandom(weaponsArray);
  }

  function computeArmourClass(armour, dexMod) {
    const effectiveDex = (armour.dexCap !== null) ? Math.min(dexMod, armour.dexCap) : dexMod;
    return armour.baseAC + (effectiveDex > 0 ? effectiveDex : 0);
  }

  function computeWeaponStats(weaponName, scores, isProficient, profBonus) {
    const data = WEAPON_DATA[weaponName];
    if (!data) return null;
    const strMod = abilityMod(scores[0]);
    const dexMod = abilityMod(scores[1]);
    let usedMod = strMod;
    if (data.ranged) {
      usedMod = dexMod;
    } else if (data.finesse) {
      usedMod = Math.max(strMod, dexMod);
    }
    const attackBonus = usedMod + (isProficient ? profBonus : 0);
    return {
      name: weaponName,
      damageDie: data.damageDie,
      damageType: data.damageType,
      attackBonus: attackBonus,
      abilityMod: usedMod
    };
  }

  // ---------- Character Generation ----------
  function generateCharacter() {
    // 1. Read Name
    let firstName = document.getElementById("firstname-input").value.trim() || "Unnamed";
    let lastName = document.getElementById("lastname-input").value.trim() || "";
    const nickname = document.getElementById("nickname-input").value.trim();

    // 2. Background Selection (Race is always Human)
    const raceData = HUMAN_DATA;
    const bgSelected = document.getElementById("background-select").value;
    const bgData = BACKGROUNDS.find(b => b.name === bgSelected);
    if (!bgData) { alert("Please select a former job."); return; }

    // 3. Add nickname if provided
    if (nickname) {
      firstName += ` "${nickname}"`;
    }

    // 4. Apply Human Ability Score Bonuses (+1 to all)
    const ABIL_ORDER = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
    let finalScores = [...currentScores];
    for (const [ability, bonus] of Object.entries(raceData.abilityScoreBonuses)) {
      const idx = ABIL_ORDER.indexOf(ability);
      if (idx !== -1) finalScores[idx] += bonus;
    }

    // 4b. Collect selected Human Features
    const selectedHumanFeatures = [];
    HUMAN_FEATURES.forEach(feat => {
      const checkbox = document.getElementById(`feature-${feat.id}`);
      if (checkbox && checkbox.checked) {
        selectedHumanFeatures.push(feat);
      }
    });

    // 4c. Collect selected Isekai Traits
    const selectedIsekaiTraits = [];
    ISEKAI_TRAITS.forEach(trait => {
      const checkbox = document.getElementById(`trait-${trait.id}`);
      if (checkbox && checkbox.checked) {
        selectedIsekaiTraits.push(trait);
      }
    });

    // 5. Select Personality Traits
    const chosenTraits = pickMultipleDistinct(PERSONALITY_TRAITS, 2);

    // 6. Determine Level (Proficiency Bonus) and Class
    const levelChoice = document.getElementById("level-select").value;
    let profBonus = 0;
    if (levelChoice === "0.5") profBonus = 1;
    else if (levelChoice === "1" || levelChoice === "2") profBonus = 2;

    // Get class path and specialization
    let selectedPath = null;
    let selectedSpec = null;
    let pathData = null;
    let specData = null;

    if (levelChoice === "1" || levelChoice === "2") {
      selectedPath = document.getElementById("path-select").value;
      if (!selectedPath) { alert("Please select a Path."); return; }
      pathData = CLASS_PATHS[selectedPath];
    }
    if (levelChoice === "2") {
      selectedSpec = document.getElementById("spec-select").value;
      if (!selectedSpec) { alert("Please select a Specialization."); return; }
      specData = CLASS_SPECIALIZATIONS[selectedSpec];
    }

    // 7. Pick Random Weapon & Armour
    const chosenWeapon = getRandomWeaponForBackground(bgData.name);
    const proficient = isProficientInWeapon(chosenWeapon, bgData.name);
    const weaponStats = computeWeaponStats(chosenWeapon, finalScores, proficient, profBonus);

    // Pick modern outfit layers
    const chosenUnderwear = pickRandom(MODERN_UNDERWEAR);
    const chosenPants = pickRandom(MODERN_PANTS);
    const chosenShirt = pickRandom(MODERN_SHIRTS);
    const chosenSweater = pickRandom(MODERN_SWEATERS);
    const chosenJacket = pickRandom(MODERN_JACKETS);
    const chosenShoes = pickRandom(MODERN_SHOES);
    const dexMod = abilityMod(finalScores[1]);
    const totalACBonus = chosenUnderwear.acBonus + chosenPants.acBonus + chosenShirt.acBonus + chosenSweater.acBonus + chosenJacket.acBonus + chosenShoes.acBonus;
    const computedAC = 10 + totalACBonus + dexMod; // 15 + DEX

    // 8. Compile Final Details
    const fullNameFinal = lastName ? firstName + " " + lastName : firstName;
    const raceLangs = raceData.languages.join(", ");

    // Clone background equipment
    let finalEquipment = bgData.equipment.slice();
    const bgEquipmentList = finalEquipment.map(eq => `- ${eq}`).join("<br/>");

    // Get random pocket dump items
    const pocketDump = getRandomPocketDump(4);
    const pocketDumpList = pocketDump.map(item => `- ${item}`).join("<br/>");

    const bgSkills = bgData.skillProficiencies ? bgData.skillProficiencies.join(", ") : "None";
    const bgLangs = (bgData.languages && bgData.languages.length > 0) ? bgData.languages.join(", ") : "None";

    // Collect all proficient skills (background + race features + class)
    let allProficientSkills = bgData.skillProficiencies ? [...bgData.skillProficiencies] : [];
    if (pathData && pathData.proficiencies && pathData.proficiencies.skills) {
      allProficientSkills.push(...pathData.proficiencies.skills);
    }
    if (specData && specData.bonusSkills) {
      allProficientSkills.push(...specData.bonusSkills);
    }

    // Output the generated character
    const outputDiv = document.getElementById("output");
    outputDiv.style.display = "block";
    outputDiv.classList.add("generated");
    document.getElementById("charName").innerHTML = fullNameFinal;

    // Build human features list
    let humanFeaturesHTML = "";
    if (selectedHumanFeatures.length > 0) {
      humanFeaturesHTML = selectedHumanFeatures.map(f => `- <strong>${f.name}:</strong> ${f.desc}`).join("<br/>");
    } else {
      humanFeaturesHTML = "<em>None selected</em>";
    }

    document.getElementById("charRaceInfo").innerHTML = `
      <strong>Race:</strong> ${raceData.name}<br/>
      <em>Speed:</em> ${raceData.speed} ft<br/>
      <em>Human Features:</em><br/> ${humanFeaturesHTML}
    `;

    // Build isekai traits section
    let isekaiTraitsHTML = "";
    if (selectedIsekaiTraits.length > 0) {
      isekaiTraitsHTML = `<h3>Isekai Traits</h3><ul>`;
      selectedIsekaiTraits.forEach(t => {
        isekaiTraitsHTML += `<li><strong>${t.name}:</strong> ${t.desc}</li>`;
      });
      isekaiTraitsHTML += `</ul>`;
    }
    document.getElementById("charSelectedFeatures").innerHTML = isekaiTraitsHTML;

    // Build background HTML with special bonuses
    let bgHTML = `
      <strong>Former Job:</strong> ${bgData.name}<br/>
      <em>Skill Proficiencies:</em> ${bgSkills}<br/>
      <em>Feature:</em> <strong>${bgData.feature}</strong><br/>
      <small>${bgData.featureDesc}</small>
    `;
    if (bgData.bonuses) {
      bgHTML += `<br/><br/><em style="color: #4B0082;">Special Bonus:</em> ${bgData.bonuses.description}`;
      if (bgData.bonuses.wisdomSaveBonus) {
        bgHTML += `<br/><em style="color: #4B0082;">Wisdom Save Bonus:</em> +${bgData.bonuses.wisdomSaveBonus}`;
      }
    }
    document.getElementById("charBackground").innerHTML = bgHTML;

    document.getElementById("charAbilityScores").innerHTML = formatAbilityScores(finalScores, allProficientSkills, profBonus);
    document.getElementById("charProficiencies").innerHTML = `
      <strong>Proficiencies (From Former Job, at Level ${levelChoice}):</strong><br/>
      Weapon Category: ${BACKGROUND_PROFICIENCIES[bgData.name] || "None"}<br/>
      Job Skills: ${bgSkills}
    `;
    document.getElementById("charLanguages").innerHTML = `
      <strong>Languages:</strong><br/>
      From Race: ${raceLangs}<br/>
      From Background: ${bgLangs}
    `;

    let eqHTML = `<strong>Starting Equipment:</strong><br/>${bgEquipmentList}`;
    if (weaponStats) {
      eqHTML += `
        <br/><br/><strong>Weapon:</strong> ${weaponStats.name}<br/>
        <em>Attack Bonus:</em> ${weaponStats.attackBonus >= 0 ? "+" : ""}${weaponStats.attackBonus} ${proficient ? "(proficient)" : "(not proficient)"}<br/>
        <em>Damage:</em> ${weaponStats.damageDie} ${weaponStats.abilityMod >= 0 ? "+" : ""}${weaponStats.abilityMod} (${weaponStats.damageType})
      `;
    }
    eqHTML += `<br/><br/><strong>Modern Outfit (AC ${computedAC} = 10 + ${totalACBonus} + ${dexMod} DEX):</strong><br/>`;
    eqHTML += `- ${chosenUnderwear.name}<br/>`;
    eqHTML += `- ${chosenPants.name} (+${chosenPants.acBonus})<br/>`;
    eqHTML += `- ${chosenShirt.name} (+${chosenShirt.acBonus})<br/>`;
    eqHTML += `- ${chosenSweater.name} (+${chosenSweater.acBonus})<br/>`;
    eqHTML += `- ${chosenJacket.name} (+${chosenJacket.acBonus})<br/>`;
    eqHTML += `- ${chosenShoes.name} (+${chosenShoes.acBonus})`;

    eqHTML += `<br/><br/><strong>Pocket Dump:</strong><br/>${pocketDumpList}`;
    document.getElementById("charEquipment").innerHTML = eqHTML;

    // Build class features HTML
    let classHTML = "";
    if (pathData) {
      classHTML += `<hr/><h3>${selectedPath}</h3>`;
      classHTML += `<em>${pathData.description}</em><br/><br/>`;
      classHTML += `<strong>Hit Die:</strong> ${pathData.hitDie}<br/>`;
      classHTML += `<strong>Extra HP:</strong> +${pathData.extraHP}<br/>`;
      if (pathData.proficiencies.armor && pathData.proficiencies.armor.length > 0) {
        classHTML += `<strong>Armor Proficiencies:</strong> ${pathData.proficiencies.armor.join(", ")}<br/>`;
      }
      classHTML += `<strong>Weapon Proficiencies:</strong> ${pathData.proficiencies.weapons}<br/>`;
      classHTML += `<strong>Saving Throws:</strong> ${pathData.proficiencies.savingThrows.join(", ")}<br/>`;
      classHTML += `<strong>Class Skills:</strong> ${pathData.proficiencies.skills.join(", ")}<br/><br/>`;
      classHTML += `<strong>Features:</strong><ul>`;
      pathData.features.forEach(f => {
        classHTML += `<li>${f}</li>`;
      });
      classHTML += `</ul>`;
      if (pathData.spells) {
        classHTML += `<strong>Cantrips:</strong> ${pathData.spells.cantrips.join(", ")}<br/>`;
        classHTML += `<strong>1st Level Spells:</strong> ${pathData.spells.level1.join(", ")}<br/>`;
      }
    }
    if (specData) {
      classHTML += `<hr/><h3>${selectedSpec}</h3>`;
      classHTML += `<em>${specData.description}</em><br/><br/>`;
      classHTML += `<strong>Additional HP:</strong> +${specData.extraHP}<br/>`;
      if (specData.bonusAC) {
        classHTML += `<strong>Bonus AC:</strong> +${specData.bonusAC}<br/>`;
      }
      if (specData.bonusDamage) {
        classHTML += `<strong>Bonus Melee Damage:</strong> +${specData.bonusDamage}<br/>`;
      }
      if (specData.sneakAttackDice) {
        classHTML += `<strong>Sneak Attack:</strong> ${specData.sneakAttackDice}<br/>`;
      }
      classHTML += `<br/><strong>Features:</strong><ul>`;
      specData.features.forEach(f => {
        classHTML += `<li>${f}</li>`;
      });
      classHTML += `</ul>`;
      if (specData.spells) {
        classHTML += `<strong>Cantrips:</strong> ${specData.spells.cantrips.join(", ")}<br/>`;
        classHTML += `<strong>1st Level Spells:</strong> ${specData.spells.level1.join(", ")}<br/>`;
      }
    }
    document.getElementById("charClass").innerHTML = classHTML;

    const traitsHTML = `
      <h3>Personality Traits</h3>
      <ul>
        <li>${chosenTraits[0]}</li>
        <li>${chosenTraits[1]}</li>
      </ul>
    `;
    document.getElementById("charTraits").innerHTML = traitsHTML;

    document.getElementById("printButton").style.display = "inline-block";
  }

  function formatAbilityScores(scoresArr, proficientSkills = [], profBonus = 0) {
    const labels = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
    let out = "<strong>Ability Scores & Skills:</strong><br/><div style='text-align: left; display: inline-block;'>";
    scoresArr.forEach((sc, i) => {
      const abil = labels[i];
      const mod = abilityMod(sc);
      const modStr = (mod >= 0 ? "+" : "") + mod;
      out += `<strong>${abil}: ${sc}</strong> (${modStr})<br/>`;

      const skills = SKILLS_BY_ABILITY[abil];
      if (skills && skills.length > 0) {
        skills.forEach(skill => {
          const isProficient = proficientSkills.includes(skill);
          const skillMod = mod + (isProficient ? profBonus : 0);
          const skillModStr = (skillMod >= 0 ? "+" : "") + skillMod;
          const checkbox = isProficient ? "☑" : "☐";
          out += `&nbsp;&nbsp;${checkbox} ${skill} (${skillModStr})<br/>`;
        });
      }
    });
    out += "</div>";
    return out;
  }

  function fullRandom() {
    randomBackground();
    // Randomly pick a level
    const levels = ["0", "0.5", "1", "2"];
    const randomLevel = pickRandom(levels);
    document.getElementById("level-select").value = randomLevel;
    updateClassOptions();

    if (randomLevel === "1" || randomLevel === "2") {
      randomPath();
    }
    if (randomLevel === "2") {
      randomSpec();
    }

    rollAbilityScores();
    // Randomly select some isekai traits (1-3)
    const traitCount = Math.floor(Math.random() * 3) + 1;
    const traitIndices = [];
    while (traitIndices.length < traitCount) {
      const idx = Math.floor(Math.random() * ISEKAI_TRAITS.length);
      if (!traitIndices.includes(idx)) traitIndices.push(idx);
    }
    // Clear all trait checkboxes first
    ISEKAI_TRAITS.forEach(t => {
      const cb = document.getElementById(`trait-${t.id}`);
      if (cb) cb.checked = false;
    });
    // Check the random ones
    traitIndices.forEach(idx => {
      const cb = document.getElementById(`trait-${ISEKAI_TRAITS[idx].id}`);
      if (cb) cb.checked = true;
    });
    generateCharacter();
  }

  // ---------- Initialization ----------
  window.addEventListener("DOMContentLoaded", () => {
    populateSelect("background-select", BACKGROUNDS.map(b => b.name));

    // Populate Human Features checkboxes
    const humanFeaturesContainer = document.getElementById("human-features-container");
    HUMAN_FEATURES.forEach(feat => {
      const div = document.createElement("div");
      div.innerHTML = `
        <label style="width:auto; display:inline;">
          <input type="checkbox" id="feature-${feat.id}" />
          <strong>${feat.name}:</strong> <small>${feat.desc}</small>
        </label>
      `;
      humanFeaturesContainer.appendChild(div);
    });

    // Populate Isekai Traits checkboxes
    const isekaiTraitsContainer = document.getElementById("isekai-traits-container");
    ISEKAI_TRAITS.forEach(trait => {
      const div = document.createElement("div");
      div.style.marginBottom = "0.5rem";
      div.innerHTML = `
        <label style="width:auto; display:inline;">
          <input type="checkbox" id="trait-${trait.id}" />
          <strong>${trait.name}:</strong> <small>${trait.desc}</small>
        </label>
      `;
      isekaiTraitsContainer.appendChild(div);
    });
  });
</script>
</body>
</html>
