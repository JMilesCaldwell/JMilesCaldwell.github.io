<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestiary & Initiative Tracker</title>
  <link rel="icon" href="/resources/compass_favicon_32x32.png" type="image/png">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Almendra&family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body {
      margin: 0;
      background: url('resources/bestiary.png') center/cover fixed no-repeat;
      color: #FAF4E0;
      font-family: 'Almendra', serif;
      text-align: center;
    }
    h1,h2 { font-family: 'Cinzel', serif; margin:0 0 .5rem }
    .container {
      max-width: 840px;
      margin: 2rem auto;
      background: rgba(0,0,0,.7);
      padding: 2rem;
      border-radius: 10px;
    }
    label { display:inline-block;width:150px;margin-right:8px;font-weight:bold }
    select, .button {
      font-family: 'Cinzel', serif;
      background: #8B0000;
      color: #fff;
      border: none;
      padding: .5rem 1rem;
      margin: .3rem;
      cursor: pointer;
      border-radius:4px;
    }
    select {
      background: #fff9ed;
      color: #333;
      border:1px solid #999;
    }
    select:focus, .button:focus { outline: none; }
    #definitions { display:none; }
    #pinned-container { margin-top:1rem; }
    .pinned-entry {
      position: relative;
      background: rgba(0,0,0,0.8);
      border-radius: 6px;
      padding: 1rem;
      margin: .5rem 0;
      color: #FAF4E0;
      text-align: left;
    }
    .pinned-entry .remove-btn {
      position: absolute;
      top: .3rem;
      right: .3rem;
      background: transparent;
      border: none;
      color: #FAF4E0;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .pinned-entry .controls {
      margin-bottom: .5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .pinned-entry .controls label {
      color:#FAF4E0;
      font-family:'Cinzel',serif;
    }
    .pinned-entry .controls input {
      width:4rem;
      padding:.2rem;
      border:1px solid #999;
      border-radius:4px;
      font-family:inherit;
    }
    .creature-data {
      white-space: normal;
      margin-top: .5rem;
    }
    @media print {
      body * { visibility:hidden!important }
      #pinned-container,#pinned-container * { visibility:visible!important }
      #pinned-container { position:absolute;top:0;left:0;width:100% }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bestiary & Initiative Tracker</h1>
    <div>
      <label for="creature-select">Select Creature:</label>
      <select id="creature-select"><option value="">-- choose --</option></select>
      <button class="button" id="pin-button">Pin</button>
      <button class="button" id="add-button">Add Blank Entry</button>
      <button class="button" id="clear-button">Clear All</button>
    </div>
    <div id="pinned-container"></div>
    <div id="definitions"></div>
  </div>

  <script>
    // slugify helper
    function slugify(str) {
      return str.toLowerCase()
                .replace(/[^a-z0-9]+/g,'-')
                .replace(/(^-|-$)/g,'');
    }

    // render a creature object into HTML
    function renderCreatureHTML(c) {
      let html = `<h2>${c.name} (CR ${c.cr})</h2>
        <p><strong>Type:</strong> ${c.size} ${c.type}, ${c.alignment}</p>
        <p><strong>AC:</strong> ${c.ac}    <strong>HP:</strong> ${c.hp}    <strong>Speed:</strong> ${c.speed}</p>
        <p><strong>STR</strong> ${c.str} | <strong>DEX</strong> ${c.dex} | <strong>CON</strong> ${c.con}
           | <strong>INT</strong> ${c.int} | <strong>WIS</strong> ${c.wis} | <strong>CHA</strong> ${c.cha}</p>`;
      ['saves','skills','immune','languages','senses'].forEach(f => {
        if (c[f]) html += `<p><strong>${f.charAt(0).toUpperCase()+f.slice(1)}:</strong> ${c[f]}</p>`;
      });
      if (c.traits?.length) {
        html += '<h3>Traits</h3><ul>';
        c.traits.forEach(t => html += `<li><strong>${t.name}:</strong> ${t.desc}</li>`);
        html += '</ul>';
      }
      if (c.actions?.length) {
        html += '<h3>Actions</h3><ul>';
        c.actions.forEach(a => html += `<li><strong>${a.name}:</strong> ${a.desc}</li>`);
        html += '</ul>';
      }
      return html;
    }

    // sort pinned entries by initiative desc
    function sortPinned() {
      const container = document.getElementById('pinned-container');
      Array.from(container.children)
        .sort((a,b) => {
          const ai = parseInt(a.querySelector('.init-input').value)||0;
          const bi = parseInt(b.querySelector('.init-input').value)||0;
          return bi - ai;
        })
        .forEach(n=>container.appendChild(n));
    }

    // load YAML and populate select + hidden definitions
    async function loadBestiary() {
      const res  = await fetch('resources/bestiary.yml');
      const text = await res.text();
      const data = jsyaml.load(text);
      const sel  = document.getElementById('creature-select');
      const defs = document.getElementById('definitions');
      Object.entries(data).forEach(([faction,list])=>{
        if (!Array.isArray(list)) return;
        list.forEach(c=>{
          const id = slugify(`${faction}-${c.name}`);
          // option
          const opt = document.createElement('option');
          opt.value = id;
          opt.text = `${faction} — ${c.name}`;
          sel.appendChild(opt);
          // hidden template
          const tpl = document.createElement('div');
          tpl.id = id;
          tpl.dataset.hp = c.hp;
          const block = document.createElement('div');
          block.className = 'creature-data';
          block.innerHTML = renderCreatureHTML(c);
          tpl.appendChild(block);
          defs.appendChild(tpl);
        });
      });
    }

    document.addEventListener('DOMContentLoaded',()=>{
      loadBestiary();

      const pinBtn   = document.getElementById('pin-button');
      const addBtn   = document.getElementById('add-button');
      const clearBtn = document.getElementById('clear-button');
      const sel      = document.getElementById('creature-select');
      const defs     = document.getElementById('definitions');
      const pinCon   = document.getElementById('pinned-container');

      function makeEntry(id, maxHP, contentHTML) {
        const wrapper = document.createElement('div');
        wrapper.className = 'pinned-entry';
        wrapper.id = `pinned-${id}`;
        // remove
        const rm = document.createElement('button');
        rm.className = 'remove-btn';
        rm.textContent = '×';
        rm.title = 'Remove';
        rm.onclick = ()=>wrapper.remove();
        wrapper.appendChild(rm);
        // controls
        const ctrl = document.createElement('div');
        ctrl.className = 'controls';
        ctrl.innerHTML = `
          <label>Init: <input type="number" class="init-input" value="0"></label>
          <label>HP: <span class="max-hp">${maxHP}</span> Curr <input type="number" class="cur-hp" value="${maxHP}"></label>
        `;
        ctrl.querySelector('.init-input').addEventListener('input', sortPinned);
        wrapper.appendChild(ctrl);
        // content
        const content = document.createElement('div');
        content.className = 'creature-data';
        content.innerHTML = contentHTML;
        wrapper.appendChild(content);
        return wrapper;
      }

      // pin existing
      pinBtn.onclick = ()=>{
        const id = sel.value;
        if (!id || document.getElementById(`pinned-${id}`)) return;
        const tpl = document.getElementById(id);
        const maxHP = tpl.dataset.hp;
        const html  = tpl.querySelector('.creature-data').innerHTML;
        pinCon.appendChild(makeEntry(id,maxHP,html));
      };

      // add blank
      addBtn.onclick = ()=>{
        const uid = `custom-${Date.now()}`;
        const blankHTML = `<h2 contenteditable="true">Creature Name</h2>
          <p contenteditable="true"><strong>Type:</strong> …</p>
          <p contenteditable="true"><strong>AC:</strong> …  <strong>HP:</strong> 0  <strong>Speed:</strong> …</p>`;
        pinCon.appendChild(makeEntry(uid,0,blankHTML));
      };

      // clear all
      clearBtn.onclick = ()=>pinCon.innerHTML = '';
    });
  </script>
</body>
</html>
