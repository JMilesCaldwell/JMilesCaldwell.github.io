<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestiary</title>
  <link rel="icon" href="/resources/compass_favicon_32x32.png" type="image/png">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almendra&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body {
      margin: 0;
      background: url('resources/bestiary.png') center/cover fixed no-repeat;
      color: #FAF4E0;
      font-family: 'Almendra', serif;
      text-align: center;
    }
    h1, h2 {
      font-family: 'Cinzel', serif;
      margin: 0 0 .5rem;
    }
    .container {
      max-width: 840px;
      margin: 2rem auto;
      background: rgba(0,0,0,.7);
      padding: 2rem;
      border-radius: 10px;
    }
    label {
      display: inline-block;
      width: 150px;
      margin-right: 8px;
      font-weight: bold;
    }
    select {
      padding: .3rem;
      background: #fff9ed;
      border: 1px solid #999;
      color: #333;
      font-family: 'Cinzel', serif;
    }
    .button {
      font-family: 'Cinzel', serif;
      background: #8B0000;
      color: #fff;
      border: none;
      padding: .5rem 1rem;
      margin: .3rem;
      cursor: pointer;
    }
    .button:hover {
      background: #6B0000;
    }
    .creature {
      margin: 2rem 0;
      text-align: left;
      border-top: 1px solid #8B0000;
      padding-top: 1rem;
      display: none;
    }
    #definitions {
      display: none;
    }
    #pinned-container .creature {
      display: block;
    }
    @media print {
      body * { visibility: hidden !important; }
      #pinned-container, #pinned-container * { visibility: visible !important; }
      #pinned-container { position: absolute; top: 0; left: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bestiary</h1>
    <label for="creature-select">Select Creature:</label>
    <select id="creature-select"><option value="">-- choose --</option></select>
    <button class="button" id="pin-button">Pin</button>
    <button class="button" id="clear-button">Clear All</button>
    <div id="pinned-container"></div>
    <div id="definitions"></div>
  </div>

  <script>
    // slugify helper
    function slugify(str) {
      return str.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');
    }

    // render a single creature object to HTML
    function renderCreatureHTML(faction, creature) {
      let html = `<h2>${creature.name} (CR ${creature.cr})</h2>
        <p><strong>Type:</strong> ${creature.size} ${creature.type}, ${creature.alignment}</p>
        <p>
          <strong>AC:</strong> ${creature.ac}  
          <strong>HP:</strong> ${creature.hp}  
          <strong>Speed:</strong> ${creature.speed}
        </p>
        <p>
          <strong>STR</strong> ${creature.str} |
          <strong>DEX</strong> ${creature.dex} |
          <strong>CON</strong> ${creature.con} |
          <strong>INT</strong> ${creature.int} |
          <strong>WIS</strong> ${creature.wis} |
          <strong>CHA</strong> ${creature.cha}
        </p>`;

      if (creature.saves)      html += `<p><strong>Saves:</strong> ${creature.saves}</p>`;
      if (creature.skills)     html += `<p><strong>Skills:</strong> ${creature.skills}</p>`;
      if (creature.immune)     html += `<p><strong>Immune:</strong> ${creature.immune}</p>`;
      if (creature.languages)  html += `<p><strong>Languages:</strong> ${creature.languages}</p>`;
      if (creature.senses)     html += `<p><strong>Senses:</strong> ${creature.senses}</p>`;

      if (creature.traits && creature.traits.length) {
        html += `<h3>Traits</h3><ul>`;
        creature.traits.forEach(t => {
          html += `<li><strong>${t.name}:</strong> ${t.desc}</li>`;
        });
        html += `</ul>`;
      }

      if (creature.actions && creature.actions.length) {
        html += `<h3>Actions</h3><ul>`;
        creature.actions.forEach(a => {
          html += `<li><strong>${a.name}:</strong> ${a.desc}</li>`;
        });
        html += `</ul>`;
      }

      return html;
    }

    async function loadBestiary() {
      try {
        const res    = await fetch('resources/bestiary.yml');
        const text   = await res.text();
        const data   = jsyaml.load(text);
        const sel    = document.getElementById('creature-select');
        const defs   = document.getElementById('definitions');

        Object.entries(data).forEach(([faction, list]) => {
          if (!Array.isArray(list)) return;
          list.forEach(creature => {
            const id    = slugify(`${faction}-${creature.name}`);
            const opt   = document.createElement('option');
            opt.value   = id;
            opt.text    = `${faction} — ${creature.name}`;
            sel.appendChild(opt);

            const div         = document.createElement('div');
            div.id            = id;
            div.className     = 'creature';
            div.innerHTML     = renderCreatureHTML(faction, creature);
            defs.appendChild(div);
          });
        });
      } catch (err) {
        console.error('Failed to load Bestiary YAML:', err);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadBestiary();

      // pin logic
      document.getElementById('pin-button').onclick = () => {
        const selVal = document.getElementById('creature-select').value;
        if (!selVal) return;
        if (document.getElementById('pinned-' + selVal)) return;
        const orig = document.getElementById(selVal);
        const clone = orig.cloneNode(true);
        clone.id = 'pinned-' + selVal;
        document.getElementById('pinned-container').appendChild(clone);
      };

      // clear all
      document.getElementById('clear-button').onclick = () => {
        document.getElementById('pinned-container').innerHTML = '';
      };
    });
  </script>
</body>
</html>
