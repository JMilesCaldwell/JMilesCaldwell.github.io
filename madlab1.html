<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Identification → Shopify Schema</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; background:#0f1115; color:#e6e6e6; margin:0; padding:20px; }
    h1 { margin:0 0 10px; }
    textarea { width:100%; min-height:200px; background:#1a1c22; color:#e6e6e6; border:1px solid #333; padding:10px; }
    button { margin-top:10px; padding:8px 12px; border:0; border-radius:4px; background:#2b6cb0; color:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:.9em; color:#9aa0a6; }
  </style>
</head>
<body>
  <h1>Identification → Shopify Schema</h1>
  <p class="hint">
    Takes CSV with headers <code>Type,Identification,...</code>.<br>
    For each <code>PRODUCT</code> row, outputs three rows:<br>
    <code>PRODUCT,&lt;Identification&gt;,title</code><br>
    <code>PRODUCT,&lt;Identification&gt;,body_html</code><br>
    <code>PRODUCT,&lt;Identification&gt;,handle</code>
  </p>

  <input id="file" type="file" accept=".csv,text/csv"><br><br>
  <textarea id="output" placeholder="Output will appear here..." readonly></textarea><br>
  <button id="download" disabled>Download CSV</button>

<script>
const fileInput = document.getElementById('file');
const outputArea = document.getElementById('output');
const dlBtn = document.getElementById('download');
let lastBlobUrl = null;

// Simple CSV field splitter that respects quoted values
function splitCsvLine(line) {
  const regex = /("([^"]*)"|[^,]*)(,|$)/g;
  const result = [];
  let match;
  while ((match = regex.exec(line)) !== null) {
    let value = match[2] !== undefined ? match[2] : match[1];
    result.push(value.trim());
    if (match[3] === '') break;
  }
  return result;
}

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const text = await file.text();
  const lines = text.replace(/\r\n/g, '\n').split('\n');
  if (lines.length <= 1) { alert("File seems empty"); return; }

  const out = [];
  const fields = ['title','body_html','handle'];

  for (let i=1; i<lines.length; i++){ // skip header row
    const row = lines[i].trim();
    if (!row) continue;
    const parts = splitCsvLine(row);
    if (!parts.length) continue;

    if (parts[0].trim().toUpperCase() !== 'PRODUCT') continue;
    const identification = (parts[1] || '').trim();
    if (!identification) continue;

    for (const f of fields){
      out.push(['PRODUCT', identification, f].join(','));
    }
  }

  const csvOut = out.join('\n');
  outputArea.value = csvOut;

  // enable download
  if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
  const blob = new Blob([csvOut], { type: 'text/csv;charset=utf-8' });
  lastBlobUrl = URL.createObjectURL(blob);
  dlBtn.disabled = !csvOut;
  dlBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = lastBlobUrl;
    a.download = "shopify_import.csv";
    a.click();
  };
});
</script>
</body>
</html>
